<!-- File: documents.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Documents - Browse, preview, tag, and manage project files in Project Atlas"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Documents - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÅ</text></svg>">

  <!-- Global Styles (shared) -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* ====== Documents page styles (keeps existing palette & rounding) ====== */
    .page-wrap{padding:var(--space-xl);max-width:1600px;margin:0 auto}

    .docs-header{display:flex;flex-wrap:wrap;gap:var(--space-lg);align-items:center;justify-content:space-between;margin-bottom:var(--space-xl);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-default)}
    .docs-title h2{margin-bottom:6px}

    /* NEW: compact toolbar + expandable filters */
    .toolbar{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      background:var(--bg-elevated);border:1px solid var(--border-light);
      border-radius:var(--radius-lg);padding:10px 12px;width:100%;
    }
    .toolbar .search{position:relative;flex:1;min-width:220px}
    .toolbar .search input{min-width:0;width:100%;padding:8px 34px 8px 10px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md)}
    .toolbar .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:.6}
    .toolbar .summary-btn{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;
      border:1px solid var(--border-default);border-radius:var(--radius-md);
      background:var(--bg-secondary);cursor:pointer;white-space:nowrap;color:var(--text-primary);
    }
    .toolbar .summary-btn:hover{border-color:var(--app-primary);color:var(--app-primary)}
    .toolbar .badge{display:inline-block;min-width:1.25rem;height:1.25rem;line-height:1.25rem;text-align:center;border-radius:999px;font-size:.75rem;background:var(--app-primary-lighter);color:var(--app-primary)}
    .filters-wrap{overflow:hidden;transition:max-height .2s ease,opacity .2s ease,margin-top .2s ease;max-height:0;opacity:0;margin-top:0}
    .filters-wrap.open{max-height:320px;opacity:1;margin-top:10px}
    .filters-grid{
      display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px;
      background:var(--bg-secondary);border:1px solid var(--border-light);
      border-radius:var(--radius-lg);padding:12px
    }

    .btn-icon{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast)}
    .btn-icon:hover{border-color:var(--app-primary);background:var(--app-primary-lighter);color:var(--app-primary)}
    .visually-hidden{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}

    .filter-select,.sort-select{padding:10px 12px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md)}
    .toggle{display:inline-flex;border:1px solid var(--border-default);border-radius:var(--radius-md);overflow:hidden}
    .toggle button{padding:10px 12px;border:0;background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer}
    .toggle button.active{background:var(--app-primary);color:#fff}

    .layout{display:grid;grid-template-columns:270px 1fr;gap:var(--space-xl)}
    .sidebar{display:flex;flex-direction:column;gap:var(--space-lg)}
    .card{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm)}
    .card-header{padding:12px 16px;border-bottom:1px solid var(--border-light);font-weight:600}
    .card-body{padding:12px 16px}

    .folder-list{display:flex;flex-direction:column;gap:10px}
    .folder{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border-light);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast)}
    .folder:hover{border-color:var(--app-primary);background:var(--app-primary-lighter)}
    .folder .count{font-weight:700;color:var(--text-secondary)}

    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{padding:4px 10px;border-radius:999px;border:1px solid var(--border-light);background:var(--bg-elevated);font-size:.8125rem;cursor:pointer}
    .tag.active{border-color:var(--app-primary);background:var(--app-primary-lighter);color:var(--app-primary);font-weight:700}

    .stats{display:flex;flex-direction:column;gap:8px}
    .stat{display:flex;justify-content:space-between;border-bottom:1px solid var(--border-light);padding:6px 0}
    .stat:last-child{border-bottom:0}

    /* Grid/List Area */
    .content{display:flex;flex-direction:column;gap:var(--space-lg)}
    .crumbs{font-size:.9rem;color:var(--text-secondary)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-lg)}
    .doc{position:relative;display:flex;flex-direction:column;gap:10px;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow-xs);transition:transform .12s ease, box-shadow .12s ease}
    .doc:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .doc .thumb{height:150px;border-radius:var(--radius-md);background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid var(--border-light)}
    .doc .thumb img{max-width:100%;max-height:100%;display:block}
    .doc .meta{display:flex;flex-direction:column;gap:4px}
    .doc .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .doc .sub{color:var(--text-secondary);font-size:.85rem}
    .doc .tags{margin-top:8px}
    .doc .actions{position:absolute;top:10px;right:10px;display:flex;gap:8px}
    .icon-btn{width:32px;height:32px;border-radius:999px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn:hover{color:var(--app-primary);border-color:var(--app-primary)}

    .list{display:grid;grid-template-columns:1fr 120px 140px 140px 100px 60px;gap:0;border:1px solid var(--border-default);border-radius:var(--radius-lg);overflow:hidden}
    .list .row{display:contents}
    .list .cell{padding:12px 14px;border-bottom:1px solid var(--border-light);background:var(--bg-secondary)}
    .list .head .cell{background:var(--bg-elevated);font-weight:700}
    .list .cell.actions{display:flex;gap:8px;align-items:center}
    .list .cell.name{display:flex;gap:10px;align-items:center}
    .list .file-icon{width:28px;height:28px;border-radius:6px;background:var(--bg-elevated);border:1px solid var(--border-light);display:flex;align-items:center;justify-content:center;font-weight:800}

    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .pagination button{padding:8px 12px;border:1px solid var(--border-default);background:var(--bg-secondary);border-radius:var(--radius-md)}
    .pagination .info{color:var(--text-secondary);margin-right:auto}

    /* Project color pills */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:3px 10px;border-radius:999px;border:1px solid var(--border-light);font-size:.8rem}
    .pill.kitchen{background:rgba(33,150,243,.12);color:#2196f3}
    .pill.bathroom{background:rgba(255,152,0,.12);color:#ff9800}
    .pill.basement{background:rgba(76,175,80,.12);color:#4caf50}

    /* Modal & toast (reuse calendar styles) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1000}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1001}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-panel{width:min(900px,94vw);max-height:90vh;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:flex;flex-direction:column;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border-light)}
    .modal-title{font-size:1.125rem}
    .modal-close{background:transparent;border:0;font-size:1.5rem;cursor:pointer;color:var(--text-secondary)}
    .modal-body{padding:16px;overflow:auto}
    .modal-footer{padding:12px 16px;border-top:1px solid var(--border-light);display:flex;gap:10px;justify-content:flex-end}

    .preview{display:grid;grid-template-columns:280px 1fr;gap:16px}
    .preview .pane{border:1px solid var(--border-light);border-radius:var(--radius-md);overflow:hidden;background:var(--bg-elevated)}
    .preview .pane .placeholder{height:260px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary)}
    .preview .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .preview .meta .field{display:flex;flex-direction:column;gap:4px}
    .input, .textarea, select.input{width:100%;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:8px;padding:10px}
    .textarea{min-height:90px}

    @media (max-width:1200px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:992px){.layout{grid-template-columns:1fr}.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:880px){ .filters-grid{grid-template-columns:repeat(2,minmax(140px,1fr))} }
    @media (max-width:640px){
      .toolbar{padding:10px}
      .grid{grid-template-columns:1fr}
      .preview{grid-template-columns:1fr}
      .list{grid-template-columns:1.2fr .9fr .9fr .9fr .7fr .5fr}
    }
  </style>
</head>
<body class="app-page">
  <a href="#main" class="skip-to-main">Skip to content</a>

  <!-- Header (kept consistent) -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mainNav">
        <span aria-hidden="true">‚ò∞</span>
      </button>

      <nav class="main-nav" id="mainNav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html" class="active" aria-current="page">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu">
        <label class="btn-icon" for="fileInput">
          <span aria-hidden="true">‚¨ÜÔ∏è</span> Upload
        </label>
        <input id="fileInput" class="visually-hidden" type="file" multiple />
        <button class="btn-icon" onclick="openNewDocModal()"><span aria-hidden="true">Ôºã</span> New Doc</button>
        <button class="user-avatar" onclick="showUserMenu()" aria-label="User menu" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <main id="main" class="page-wrap">
    <div class="docs-header">
      <div class="docs-title">
        <h2>Documents</h2>
        <div class="crumbs" id="crumbs">All Files</div>
      </div>

      <!-- COMPACT TOOLBAR -->
      <div class="docs-actions" style="width:100%">
        <div class="toolbar" role="region" aria-label="Document search">
          <div class="search">
            <input id="searchInput" type="search" placeholder="Search by name, tag, or note‚Ä¶" />
            <span class="icon">üîé</span>
          </div>

          <button id="filtersToggle" class="summary-btn" aria-expanded="false" aria-controls="filtersPanel">
            Filters <span id="filtersBadge" class="badge" aria-hidden="true" style="display:none">0</span>
          </button>

          <div class="toggle" role="group" aria-label="View mode" style="margin-left:auto">
            <button id="gridBtn" class="active" onclick="setView('grid')">Grid</button>
            <button id="listBtn" onclick="setView('list')">List</button>
          </div>
        </div>

        <!-- EXPANDABLE FILTERS -->
        <div id="filtersPanel" class="filters-wrap" aria-hidden="true">
          <div class="filters-grid">
            <select id="projectFilter" class="filter-select" aria-label="Filter by project">
              <option value="all">All Projects</option>
              <option value="kitchen">Kitchen Renovation</option>
              <option value="basement">Basement Finishing</option>
              <option value="bathroom">Bathroom Update</option>
            </select>

            <select id="typeFilter" class="filter-select" aria-label="Filter by type">
              <option value="all">All Types</option>
              <option value="image">Images</option>
              <option value="pdf">PDF</option>
              <option value="doc">Docs (md/txt/docx)</option>
              <option value="sheet">Spreadsheets</option>
              <option value="link">Links</option>
            </select>

            <select id="sortSelect" class="sort-select" aria-label="Sort by">
              <option value="updated_desc">Updated ‚ñæ</option>
              <option value="updated_asc">Updated ‚ñ¥</option>
              <option value="name_asc">Name A‚ÜíZ</option>
              <option value="name_desc">Name Z‚ÜíA</option>
              <option value="size_desc">Size ‚ñæ</option>
              <option value="size_asc">Size ‚ñ¥</option>
            </select>

            <div></div>
          </div>
        </div>
      </div>
      <!-- /COMPACT TOOLBAR -->
    </div>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <section class="card">
          <div class="card-header">Folders</div>
          <div class="card-body">
            <div class="folder-list" id="folderList"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">Quick Tags</div>
          <div class="card-body">
            <div class="tags" id="tagCloud"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">This Month</div>
          <div class="card-body">
            <div class="stats">
              <div class="stat"><span>Files</span><strong id="statFiles">0</strong></div>
              <div class="stat"><span>Images</span><strong id="statImages">0</strong></div>
              <div class="stat"><span>PDF</span><strong id="statPDF">0</strong></div>
              <div class="stat"><span>Docs</span><strong id="statDocs">0</strong></div>
              <div class="stat"><span>Links</span><strong id="statLinks">0</strong></div>
            </div>
          </div>
        </section>
      </aside>

      <!-- Content -->
      <section class="content">
        <div id="resultsInfo" class="pagination">
          <div class="info" id="resultCount">0 items</div>
          <button onclick="prevPage()" id="prevBtn" aria-label="Previous page">‚Äπ</button>
          <div id="pageLabel" aria-live="polite">1 / 1</div>
          <button onclick="nextPage()" id="nextBtn" aria-label="Next page">‚Ä∫</button>
        </div>

        <div id="grid" class="grid" aria-label="Document grid"></div>

        <div id="list" class="list" style="display:none" aria-label="Document list">
          <div class="row head">
            <div class="cell name">Name</div>
            <div class="cell">Project</div>
            <div class="cell">Type</div>
            <div class="cell">Updated</div>
            <div class="cell">Size</div>
            <div class="cell">‚òÖ</div>
          </div>
          <div id="listBody"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal / Backdrop -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <script>
    /* ===== Shared header controls ===== */
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const toggle = document.querySelector('.mobile-menu-toggle');
      const isExpanded = nav.classList.toggle('active');
      toggle.setAttribute('aria-expanded', isExpanded);
    }
    function showUserMenu(){
      if(window.atlas && typeof window.atlas.showUserMenu === 'function'){ window.atlas.showUserMenu(); }
    }

    /* ===== Utilities ===== */
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Los_Angeles';
    const fmtDate = (d)=> new Intl.DateTimeFormat(undefined,{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit',timeZone:tz}).format(new Date(d));
    const toKB = (b)=> Math.max(1, Math.round((b||0)/1024));
    function titleCase(s){return (s||'').replace(/\b\w/g,c=>c.toUpperCase());}
    function toast(msg){
      let t = document.getElementById('atlas-toast');
      if(!t){
        t = document.createElement('div');
        t.id='atlas-toast';
        t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b3a75;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:1200;opacity:0;transition:opacity .15s ease';
        document.body.appendChild(t);
      }
      t.textContent = msg; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 1600);
    }

    /* ===== Modal helpers ===== */
    function openModal(title, html, footerHtml){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop  = document.getElementById("backdrop");
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${(title||'').replace(/"/g,'&quot;')}">
          <div class="modal-header">
            <h3 class="modal-title">${title||''}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">${html||''}</div>
          <div class="modal-footer">${footerHtml || '<button class="btn btn-secondary" onclick="closeModal()">Close</button>'}</div>
        </div>`;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }
    function closeModal(){
      document.getElementById("modalRoot").classList.remove("open");
      document.getElementById("backdrop").classList.remove("show");
      document.getElementById("modalRoot").innerHTML = "";
      document.body.classList.remove("atlas-modal-open");
    }

    /* ===== Data store ===== */
    const DocStore = {
      key: 'atlas.docs.v1',
      read(){ try{ return JSON.parse(localStorage.getItem(this.key))||[] } catch { return [] } },
      write(list){ localStorage.setItem(this.key, JSON.stringify(list)) },
      ensureSeed(){
        const have = this.read(); if(have.length) return;
        const now = Date.now();
        const seed = [
          {id:'d1', name:'Kitchen Layout v2.pdf', type:'pdf', project:'kitchen', folder:'Design', size:428_000, tags:['layout','permit'], updated: now-86400000*1, notes:'Final layout used for cabinet order', src:'thumbs/kitchen-layout.png'},
          {id:'d2', name:'Backsplash inspiration.jpg', type:'image', project:'kitchen', folder:'Inspiration', size:1_204_000, tags:['tile','mood'], updated: now-86400000*2, notes:'Herringbone matte white', src:'https://images.unsplash.com/photo-1556910096-6f5e72db6809?w=1200'},
          {id:'d3', name:'Basement Framing Checklist.md', type:'doc', project:'basement', folder:'Plans', size:18_000, tags:['checklist'], updated: now-86400000*3, notes:'Pre-inspection checklist', src:''},
          {id:'d4', name:'City Plumbing Code.pdf', type:'pdf', project:'bathroom', folder:'Permits', size:2_800_000, tags:['code','permit'], updated: now-86400000*10, notes:'Section 14.2 - venting', src:''},
          {id:'d5', name:'Vanity Spec Sheet.png', type:'image', project:'bathroom', folder:'Specs', size:640_000, tags:['vanity','hardware'], updated: now-86400000*6, notes:'36\" matte black hardware', src:'https://images.unsplash.com/photo-1564540583246-934409427776?w=1200'},
          {id:'d6', name:'LVP Cost Model.xlsx', type:'sheet', project:'basement', folder:'Budget', size:220_000, tags:['budget','flooring'], updated: now-86400000*4, notes:'$2.39 sqft supplier', src:''},
          {id:'d7', name:'Contractor Agreement.docx', type:'doc', project:'kitchen', folder:'Contracts', size:96_000, tags:['contract'], updated: now-86400000*8, notes:'Signed by GC', src:''},
          {id:'d8', name:'Permit Portal', type:'link', project:'basement', folder:'Permits', size:0, tags:['url','permit'], updated: now-86400000*5, notes:'https://kingcounty.gov/permit-portal', href:'https://kingcounty.gov/permit-portal', src:''},
          {id:'d9', name:'Tile Pattern Options.pdf', type:'pdf', project:'bathroom', folder:'Design', size:1_540_000, tags:['tile','design'], updated: now-86400000*7, notes:''},
          {id:'d10', name:'Electrical Rough-In Map.png', type:'image', project:'basement', folder:'Plans', size:860_000, tags:['electrical','map'], updated: now-86400000*1.5, notes:'Mark for outlets', src:'https://images.unsplash.com/photo-1559884743-74a57598c6b9?w=1200'},
        ];
        this.write(seed);
      }
    };
    DocStore.ensureSeed();

    /* ===== State ===== */
    const state = {
      query: '',
      project: 'all',
      type: 'all',
      sort: 'updated_desc',
      view: 'grid',
      folder: 'All',
      tag: null,
      page: 1,
      pageSize: 12,
      favoritesKey: 'atlas.docs.favs'
    };
    function favsRead(){ try{ return JSON.parse(localStorage.getItem(state.favoritesKey))||{} }catch{ return {} } }
    function favsWrite(m){ localStorage.setItem(state.favoritesKey, JSON.stringify(m)) }

    /* ===== Elements ===== */
    const elGrid = document.getElementById('grid');
    const elList = document.getElementById('list');
    const elListBody = document.getElementById('listBody');
    const elResultCount = document.getElementById('resultCount');
    const elPageLabel = document.getElementById('pageLabel');
    const elPrev = document.getElementById('prevBtn');
    const elNext = document.getElementById('nextBtn');
    const elTagCloud = document.getElementById('tagCloud');
    const elFolderList = document.getElementById('folderList');
    const elCrumbs = document.getElementById('crumbs');

    /* ===== Filters wiring ===== */
    document.getElementById('searchInput').addEventListener('input', (e)=>{ state.query = e.target.value.trim(); state.page=1; render() });
    document.getElementById('projectFilter').addEventListener('change', (e)=>{ state.project = e.target.value; state.page=1; render(); updateFiltersBadge(); });
    document.getElementById('typeFilter').addEventListener('change', (e)=>{ state.type = e.target.value; state.page=1; render(); updateFiltersBadge(); });
    document.getElementById('sortSelect').addEventListener('change', (e)=>{ state.sort = e.target.value; state.page=1; render(); updateFiltersBadge(); });
    document.getElementById('fileInput').addEventListener('change', handleUploads);

    /* ===== Compact/Expandable controls logic ===== */
    const filtersToggle = document.getElementById('filtersToggle');
    const filtersPanel  = document.getElementById('filtersPanel');
    const filtersBadge  = document.getElementById('filtersBadge');

    function toggleFilters(){
      const open = !filtersPanel.classList.contains('open');
      filtersPanel.classList.toggle('open', open);
      filtersPanel.setAttribute('aria-hidden', String(!open));
      filtersToggle.setAttribute('aria-expanded', String(open));
    }
    function updateFiltersBadge(){
      const pf = document.getElementById('projectFilter');
      const tf = document.getElementById('typeFilter');
      const sf = document.getElementById('sortSelect');
      let n = 0;
      if(pf.value!=='all') n++;
      if(tf.value!=='all') n++;
      if(sf.value!=='updated_desc') n++;
      if(n>0){ filtersBadge.style.display='inline-block'; filtersBadge.textContent=String(n); }
      else { filtersBadge.style.display='none'; }
    }
    filtersToggle.addEventListener('click', toggleFilters);
    updateFiltersBadge();

    function setView(mode){
      state.view = mode;
      document.getElementById('gridBtn').classList.toggle('active', mode==='grid');
      document.getElementById('listBtn').classList.toggle('active', mode==='list');
      elGrid.style.display = mode==='grid' ? '' : 'none';
      elList.style.display = mode==='list' ? '' : 'none';
      render();
    }

    /* ===== Derivations ===== */
    function filtered(){
      const q = state.query.toLowerCase();
      let rows = DocStore.read();
      if(state.project!=='all') rows = rows.filter(r=> r.project===state.project);
      if(state.type!=='all') rows = rows.filter(r=> r.type===state.type);
      if(state.folder && state.folder!=='All') rows = rows.filter(r=> r.folder===state.folder);
      if(state.tag) rows = rows.filter(r=> (r.tags||[]).includes(state.tag));
      if(q) rows = rows.filter(r=>
        (r.name||'').toLowerCase().includes(q) ||
        (r.notes||'').toLowerCase().includes(q) ||
        (r.tags||[]).some(t=> t.toLowerCase().includes(q))
      );
      switch(state.sort){
        case 'updated_asc': rows.sort((a,b)=> a.updated-b.updated); break;
        case 'updated_desc': rows.sort((a,b)=> b.updated-a.updated); break;
        case 'name_asc': rows.sort((a,b)=> a.name.localeCompare(b.name)); break;
        case 'name_desc': rows.sort((a,b)=> b.name.localeCompare(a.name)); break;
        case 'size_asc': rows.sort((a,b)=> (a.size||0)-(b.size||0)); break;
        case 'size_desc': rows.sort((a,b)=> (b.size||0)-(a.size||0)); break;
      }
      return rows;
    }

    function paginated(rows){
      const totalPages = Math.max(1, Math.ceil(rows.length / state.pageSize));
      state.page = Math.min(state.page, totalPages);
      const start = (state.page-1)*state.pageSize;
      const slice = rows.slice(start, start+state.pageSize);
      return { slice, totalPages, total: rows.length };
    }

    function prevPage(){ state.page = Math.max(1, state.page-1); render() }
    function nextPage(){ const rows = filtered(); const pages = Math.max(1, Math.ceil(rows.length/state.pageSize)); state.page = Math.min(pages, state.page+1); render() }

    /* ===== Rendering ===== */
    function render(){
      const rows = filtered();
      const {slice, totalPages, total} = paginated(rows);
      elResultCount.textContent = `${total} item${total===1?'':'s'}`;
      elPageLabel.textContent = `${state.page} / ${totalPages}`;
      elPrev.disabled = state.page<=1;
      elNext.disabled = state.page>=totalPages;

      renderGrid(slice);
      renderList(slice);
      renderSidebarStats();
      renderFoldersAndTags();
      elCrumbs.textContent = state.folder==='All' ? 'All Files' : `All Files ‚Ä∫ ${state.folder}`;
    }

    function renderGrid(rows){
      const favs = favsRead();
      elGrid.innerHTML = rows.map(r=>{
        const fav = favs[r.id];
        const img = r.type==='image' && r.src ? `<img alt="" src="${r.src}"/>` :
                    r.type==='pdf' ? `<div class="placeholder">üìÑ PDF Preview</div>` :
                    r.type==='sheet' ? `<div class="placeholder">üìä Spreadsheet</div>` :
                    r.type==='doc' ? `<div class="placeholder">üìù Document</div>` :
                    r.type==='link' ? `<div class="placeholder">üîó Link</div>` :
                    `<div class="placeholder">üì¶ File</div>`;
        const tags = (r.tags||[]).slice(0,3).map(t=>`<span class="tag" onclick="filterTag('${t}')">${t}</span>`).join(' ');
        return `
          <article class="doc" role="button" onclick="openPreview('${r.id}')">
            <div class="actions" onclick="event.stopPropagation()">
              <button class="icon-btn" title="Favorite" aria-label="Favorite" onclick="toggleFav('${r.id}', event)">${favs[r.id]?'‚òÖ':'‚òÜ'}</button>
              <button class="icon-btn" title="More" aria-label="More" onclick="openDocMenu('${r.id}', event)">‚ãÆ</button>
            </div>
            <div class="thumb">${img}</div>
            <div class="meta">
              <div class="name" title="${r.name}">${r.name}</div>
              <div class="sub">
                <span class="pill ${r.project}">${titleCase(r.project)}</span>
                &nbsp;‚Ä¢&nbsp; ${titleCase(r.type)} ‚Ä¢ ${fmtDate(r.updated)}
              </div>
              <div class="tags">${tags}</div>
            </div>
          </article>`;
      }).join('');
    }

    function renderList(rows){
      const favs = favsRead();
      elListBody.innerHTML = rows.map(r=>{
        return `
          <div class="row">
            <div class="cell name">
              <div class="file-icon">${iconFor(r.type)}</div>
              <button class="btn-link" onclick="openPreview('${r.id}')">${r.name}</button>
            </div>
            <div class="cell"><span class="pill ${r.project}">${titleCase(r.project)}</span></div>
            <div class="cell">${titleCase(r.type)}</div>
            <div class="cell">${fmtDate(r.updated)}</div>
            <div class="cell">${toKB(r.size)} KB</div>
            <div class="cell actions">
              <button class="icon-btn" title="Favorite" aria-label="Favorite" onclick="toggleFav('${r.id}', event)">${favs[r.id]?'‚òÖ':'‚òÜ'}</button>
              <button class="icon-btn" title="More" aria-label="More" onclick="openDocMenu('${r.id}', event)">‚ãÆ</button>
            </div>
          </div>`;
      }).join('');
    }

    function iconFor(t){
      switch(t){
        case 'pdf': return 'üìÑ';
        case 'image': return 'üñºÔ∏è';
        case 'doc': return 'üìù';
        case 'sheet': return 'üìä';
        case 'link': return 'üîó';
        default: return 'üì¶';
      }
    }

    function renderSidebarStats(){
      const rows = filtered();
      const monthStart = new Date(); monthStart.setDate(1); monthStart.setHours(0,0,0,0);
      const monthRows = rows.filter(r=> r.updated>=+monthStart);
      const count = (t)=> monthRows.filter(r=> r.type===t).length;
      document.getElementById('statFiles').textContent = String(monthRows.length);
      document.getElementById('statImages').textContent = String(count('image'));
      document.getElementById('statPDF').textContent = String(count('pdf'));
      document.getElementById('statDocs').textContent = String(monthRows.filter(r=> r.type==='doc'||r.type==='sheet').length);
      document.getElementById('statLinks').textContent = String(count('link'));
    }

    function renderFoldersAndTags(){
      const rows = DocStore.read();
      const folders = new Map(); // name -> count
      const tags = new Map();
      rows.forEach(r=>{
        folders.set(r.folder || 'Misc', (folders.get(r.folder||'Misc')||0)+1);
        (r.tags||[]).forEach(t=> tags.set(t, (tags.get(t)||0)+1));
      });

      // Folders
      const entries = Array.from(folders.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
      const allCount = rows.length;
      elFolderList.innerHTML = `
        <div class="folder" onclick="setFolder('All')"><span>üìÅ All</span><span class="count">${allCount}</span></div>
        ${entries.map(([name,count])=>`<div class="folder" onclick="setFolder('${name.replace(/'/g,"\\'")}')"><span>üìÅ ${name}</span><span class="count">${count}</span></div>`).join('')}
      `;

      // Tags
      const tagEntries = Array.from(tags.entries()).sort((a,b)=> b[1]-a[1]).slice(0,12);
      elTagCloud.innerHTML = tagEntries.map(([t,count])=>`<span class="tag ${state.tag===t?'active':''}" onclick="filterTag('${t.replace(/'/g,"\\'")}')">#${t} (${count})</span>`).join('');
    }

    function setFolder(name){ state.folder = name; state.page=1; render() }
    function filterTag(t){ state.tag = (state.tag===t) ? null : t; state.page=1; render() }

    /* ===== Context menu (lightweight) ===== */
    function openDocMenu(id, ev){
      ev.preventDefault();
      const menu = document.createElement('div');
      menu.style.cssText = 'position:absolute;z-index:1200;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:10px;box-shadow:var(--shadow-lg);overflow:hidden';
      menu.innerHTML = `
        <button class="btn" style="display:block;width:100%;text-align:left;border-radius:0" onclick="renameDoc('${id}'); this.parentElement.remove()">Rename</button>
        <button class="btn" style="display:block;width:100%;text-align:left;border-radius:0" onclick="moveDoc('${id}'); this.parentElement.remove()">Move to Folder</button>
        <button class="btn btn-secondary" style="display:block;width:100%;text-align:left;border-radius:0" onclick="deleteDoc('${id}'); this.parentElement.remove()">Delete</button>
      `;
      document.body.appendChild(menu);
      const r = ev.target.getBoundingClientRect();
      menu.style.left = (r.left-40)+'px';
      menu.style.top = (r.bottom+6+window.scrollY)+'px';
      const closer = ()=>{ menu.remove(); document.removeEventListener('click', closer) };
      setTimeout(()=> document.addEventListener('click', closer), 0);
    }

    /* ===== Favorites ===== */
    function toggleFav(id, ev){
      const m = favsRead();
      if(m[id]) delete m[id]; else m[id] = true;
      favsWrite(m);
      ev.stopPropagation();
      render();
    }

    /* ===== Upload & New doc ===== */
    async function handleUploads(e){
      const files = Array.from(e.target.files||[]);
      if(!files.length) return;
      const list = DocStore.read();
      const now = Date.now();
      for(const f of files){
        const type = guessTypeFromName(f.name);
        const id = cryptoRandomId();
        let src = '';
        if(type==='image'){
          src = await fileToDataUrl(f);
        }
        list.unshift({
          id, name:f.name, type, project: state.project==='all' ? inferProjectFromContext() : state.project,
          folder: state.folder==='All' ? 'Uploads' : state.folder, size:f.size, tags:[], updated: now, notes:'', src
        });
      }
      DocStore.write(list);
      e.target.value = '';
      toast('Uploaded ' + files.length + ' file' + (files.length>1?'s':'') + '.');
      render();
    }

    function openNewDocModal(){
      openModal('Create Document', `
        <div class="preview">
          <div class="pane">
            <div class="placeholder" id="newPreview">Select a type to see icon</div>
          </div>
          <div class="pane" style="padding:12px;background:transparent;border:none">
            <div class="meta">
              <div class="field">
                <label for="nd_name">Name</label>
                <input id="nd_name" class="input" placeholder="e.g., Punch List.md"/>
              </div>
              <div class="field">
                <label for="nd_type">Type</label>
                <select id="nd_type" class="input">
                  <option value="doc">Doc (md/txt)</option>
                  <option value="link">Link</option>
                  <option value="sheet">Spreadsheet</option>
                  <option value="pdf">PDF</option>
                </select>
              </div>
              <div class="field">
                <label for="nd_project">Project</label>
                <select id="nd_project" class="input">
                  <option value="kitchen">Kitchen Renovation</option>
                  <option value="basement">Basement Finishing</option>
                  <option value="bathroom">Bathroom Update</option>
                </select>
              </div>
              <div class="field">
                <label for="nd_folder">Folder</label>
                <input id="nd_folder" class="input" placeholder="e.g., Plans"/>
              </div>
              <div class="field" style="grid-column:1/3">
                <label for="nd_notes">Notes</label>
                <textarea id="nd_notes" class="textarea" placeholder="Optional notes"></textarea>
              </div>
            </div>
          </div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="createDoc()">Create</button>
      `);

      // dynamic type preview
      const sel = document.getElementById('nd_type');
      const pv = document.getElementById('newPreview');
      sel.addEventListener('change', ()=>{ pv.textContent = iconFor(sel.value)+' '+titleCase(sel.value) });
      pv.textContent = iconFor(sel.value)+' '+titleCase(sel.value);
    }

    function createDoc(){
      const name = (document.getElementById('nd_name').value || '').trim();
      if(!name){ toast('Name is required.'); return; }
      const type = document.getElementById('nd_type').value;
      const project = document.getElementById('nd_project').value;
      const folder = (document.getElementById('nd_folder').value || 'General').trim();
      const notes = document.getElementById('nd_notes').value;

      const list = DocStore.read();
      list.unshift({
        id: cryptoRandomId(), name, type, project, folder, size: 0, tags:[], updated: Date.now(), notes, src:''
      });
      DocStore.write(list);
      closeModal();
      toast('Document created.');
      render();
    }

    /* ===== Preview / Edit ===== */
    function openPreview(id){
      const list = DocStore.read();
      const r = list.find(x=> x.id===id);
      if(!r){ toast('File not found'); return; }

      // Thumbnail / preview pane content
      let previewHTML = '';
      if(r.type==='image' && r.src){
        previewHTML = `<img alt="" src="${r.src}" style="display:block;max-width:100%;max-height:400px;margin:auto">`;
      } else if(r.type==='pdf'){
        previewHTML = `<div class="placeholder" style="height:400px">üìÑ PDF preview not embedded. <br/>Use ‚ÄúOpen‚Äù to view.</div>`;
      } else if(r.type==='link'){
        previewHTML = `<div class="placeholder" style="height:400px">üîó <a href="${r.href||'#'}" target="_blank" rel="noopener">Open Link</a></div>`;
      } else {
        previewHTML = `<div class="placeholder" style="height:400px">${iconFor(r.type)} No inline preview.</div>`;
      }

      openModal(r.name, `
        <div class="preview">
          <div class="pane" style="display:flex;align-items:center;justify-content:center">${previewHTML}</div>
          <div class="pane" style="padding:12px;background:transparent;border:none">
            <div class="meta">
              <div class="field">
                <label for="ed_name">Name</label>
                <input id="ed_name" class="input" value="${(r.name||'').replace(/"/g,'&quot;')}"/>
              </div>
              <div class="field">
                <label for="ed_type">Type</label>
                <select id="ed_type" class="input">
                  ${['image','pdf','doc','sheet','link'].map(t=>`<option value="${t}" ${t===r.type?'selected':''}>${titleCase(t)}</option>`).join('')}
                </select>
              </div>
              <div class="field">
                <label for="ed_project">Project</label>
                <select id="ed_project" class="input">
                  ${['kitchen','basement','bathroom'].map(p=>`<option value="${p}" ${p===r.project?'selected':''}>${titleCase(p)}</option>`).join('')}
                </select>
              </div>
              <div class="field">
                <label for="ed_folder">Folder</label>
                <input id="ed_folder" class="input" value="${(r.folder||'').replace(/"/g,'&quot;')}"/>
              </div>
              <div class="field">
                <label for="ed_tags">Tags (comma)</label>
                <input id="ed_tags" class="input" value="${(r.tags||[]).join(', ')}"/>
              </div>
              <div class="field">
                <label for="ed_size">Size (KB)</label>
                <input id="ed_size" class="input" type="number" value="${toKB(r.size)}"/>
              </div>
              <div class="field" style="grid-column:1/3">
                <label for="ed_notes">Notes</label>
                <textarea id="ed_notes" class="textarea">${(r.notes||'')}</textarea>
              </div>
            </div>
          </div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn btn-secondary" onclick="deleteDoc('${r.id}')">Delete</button>
        <button class="btn" onclick="saveDoc('${r.id}')">Save</button>
        <a class="btn" href="${r.href || r.src || '#'}" target="_blank" rel="noopener">Open</a>
      `);
    }

    function saveDoc(id){
      const list = DocStore.read();
      const i = list.findIndex(x=> x.id===id);
      if(i<0){ toast('Not found'); return; }
      list[i].name = document.getElementById('ed_name').value || list[i].name;
      list[i].type = document.getElementById('ed_type').value;
      list[i].project = document.getElementById('ed_project').value;
      list[i].folder = document.getElementById('ed_folder').value || 'General';
      list[i].tags = (document.getElementById('ed_tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
      list[i].size = Math.max(0, (parseInt(document.getElementById('ed_size').value||'0',10))*1024);
      list[i].notes = document.getElementById('ed_notes').value;
      list[i].updated = Date.now();
      DocStore.write(list);
      closeModal();
      toast('Saved.');
      render();
    }

    function renameDoc(id){
      const list = DocStore.read();
      const i = list.findIndex(x=> x.id===id);
      if(i<0){ toast('Not found'); return; }
      const n = prompt('Rename to:', list[i].name);
      if(!n) return;
      list[i].name = n;
      list[i].updated = Date.now();
      DocStore.write(list);
      toast('Renamed.');
      render();
    }

    function moveDoc(id){
      const list = DocStore.read();
      const i = list.findIndex(x=> x.id===id);
      if(i<0){ toast('Not found'); return; }
      const f = prompt('Move to folder:', list[i].folder || 'General');
      if(!f) return;
      list[i].folder = f;
      list[i].updated = Date.now();
      DocStore.write(list);
      toast('Moved.');
      render();
    }

    function deleteDoc(id){
      const list = DocStore.read();
      const next = list.filter(x=> x.id!==id);
      DocStore.write(next);
      closeModal();
      toast('Deleted.');
      render();
    }

    /* ===== Helpers ===== */
    function cryptoRandomId(){ return 'd' + Math.random().toString(36).slice(2,9) }
    function guessTypeFromName(name){
      const s = (name||'').toLowerCase();
      if(/\.(png|jpe?g|webp|gif|svg)$/.test(s)) return 'image';
      if(s.endsWith('.pdf')) return 'pdf';
      if(/\.(md|txt|docx?)$/.test(s)) return 'doc';
      if(/\.(csv|xlsx?)$/.test(s)) return 'sheet';
      return 'doc';
    }
    function inferProjectFromContext(){ return 'kitchen' }
    function fileToDataUrl(file){
      return new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=> res(fr.result);
        fr.readAsDataURL(file);
      });
    }

    /* ===== Init ===== */
    (function init(){
      setView('grid'); // default
      render();
    })();
  </script>

  <!-- Optional main script if present -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
