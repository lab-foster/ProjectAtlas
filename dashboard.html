<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Project Atlas Dashboard - View and manage all your home improvement projects in one place" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Dashboard - Project Atlas</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üóÇÔ∏è</text></svg>"/>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="atlas-interactive.css" />
</head>
<body class="app-page">
    <!-- Skip to Main Content -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <!-- Application Header -->
    <header class="app-header">
        <div class="header-container">
            <!-- Logo -->
            <div class="logo">
                <h1>Project <span class="atlas-blue">ATLAS</span></h1>
                <span class="tagline">Home Project Management</span>
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle"
                    onclick="toggleMobileMenu()"
                    aria-label="Toggle navigation menu"
                    aria-expanded="false"
                    aria-controls="mainNav">
                <span aria-hidden="true">‚ò∞</span>
            </button>

            <!-- Main Navigation -->
            <nav class="main-nav" id="mainNav" aria-label="Main navigation">
                <ul>
                    <li><a href="dashboard.html" class="active" aria-current="page">Dashboard</a></li>
                    <li><a href="projects.html">Projects</a></li>
                    <li><a href="kanban.html">Kanban Board</a></li>
                    <li><a href="budget.html">Budget Tracker</a></li>
                    <li><a href="calendar.html">Calendar</a></li>
                    <li><a href="documents.html">Documents</a></li>
                </ul>
            </nav>

            <!-- User Menu -->
            <div class="user-menu">
                <button class="btn btn-secondary"
                        onclick="if(window.atlas && window.atlas.showNewProjectModal){window.atlas.showNewProjectModal();}else{openBasicNewProject();}"
                        aria-label="Create new project">
                    <span aria-hidden="true">+</span> New Project
                </button>
                <button class="user-avatar"
                        onclick="if(window.atlas && window.atlas.showUserMenu){window.atlas.showUserMenu();}"
                        aria-label="User menu"
                        title="User Menu">
                    AF
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main" id="main-content">
        <div class="dashboard-container">
            <!-- Dashboard Header -->
            <section class="dashboard-header">
                <h2>Welcome back, Andrew</h2>
                <p id="dashboardSummary">You have <strong>3 active projects</strong> and <strong>2 items</strong> that need your attention</p>
            </section>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Active Projects Section -->
                <section class="project-overview" aria-labelledby="projects-heading">
                    <h3 id="projects-heading">Active Projects</h3>

                    <div class="project-cards" id="projectCardsContainer">
                        <!-- Kitchen Renovation Project -->
                        <article class="project-card status-in-progress" data-project-id="kitchen">
                            <div class="project-header">
                                <h4>Kitchen Renovation Epic</h4>
                                <span class="status-badge in-progress" role="status">In Progress</span>
                            </div>

                            <div class="project-stats">
                                <div class="stat">
                                    <span class="stat-label">Progress</span>
                                    <div class="progress-bar" role="progressbar" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 65%">
                                        <div class="progress-fill" style="width: 65%"></div>
                                    </div>
                                    <span class="stat-value">65%</span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Budget</span>
                                    <span class="stat-value">$21,500 <span class="text-tertiary">/ $28,000</span></span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Next</span>
                                    <span class="stat-value">Countertop template</span>
                                </div>
                            </div>

                            <div class="project-actions">
                                <button class="btn-link" onclick="viewProject('kitchen')" aria-label="View Kitchen Renovation Epic board">
                                    View Epic Board
                                </button>
                                <button class="btn-link" onclick="openAddTaskModal('kitchen','Planning')" aria-label="Add tasks to Kitchen Renovation Epic">
                                    Add Tasks
                                </button>
                            </div>
                        </article>

                        <!-- Basement Finishing Project -->
                        <article class="project-card status-planning" data-project-id="basement">
                            <div class="project-header">
                                <h4>Basement Finishing Epic</h4>
                                <span class="status-badge planning" role="status">Planning</span>
                            </div>

                            <div class="project-stats">
                                <div class="stat">
                                    <span class="stat-label">Progress</span>
                                    <div class="progress-bar" role="progressbar" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 15%">
                                        <div class="progress-fill" style="width: 15%"></div>
                                    </div>
                                    <span class="stat-value">15%</span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Budget</span>
                                    <span class="stat-value">$5,200 <span class="text-tertiary">/ $35,000</span></span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Next</span>
                                    <span class="stat-value">Permit application</span>
                                </div>
                            </div>

                            <div class="project-actions">
                                <button class="btn-link" onclick="viewProject('basement')" aria-label="View Basement Finishing Epic board">
                                    View Epic Board
                                </button>
                                <button class="btn-link" onclick="openAddTaskModal('basement','Planning')" aria-label="Add tasks to Basement Finishing Epic">
                                    Add Tasks
                                </button>
                            </div>
                        </article>

                        <!-- Bathroom Update Project -->
                        <article class="project-card status-blocked" data-project-id="bathroom">
                            <div class="project-header">
                                <h4>Bathroom Update Epic</h4>
                                <span class="status-badge blocked" role="status">Blocked</span>
                            </div>

                            <div class="project-stats">
                                <div class="stat">
                                    <span class="stat-label">Progress</span>
                                    <div class="progress-bar" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 40%">
                                        <div class="progress-fill" style="width: 40%"></div>
                                    </div>
                                    <span class="stat-value">40%</span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Budget</span>
                                    <span class="stat-value">$8,100 <span class="text-tertiary">/ $12,000</span></span>
                                </div>

                                <div class="stat">
                                    <span class="stat-label">Blocked by</span>
                                    <span class="stat-value">Inspection pending</span>
                                </div>
                            </div>

                            <div class="project-actions">
                                <button class="btn-link" onclick="viewProject('bathroom')" aria-label="View Bathroom Update Epic board">
                                    View Epic Board
                                </button>
                                <button class="btn-link" onclick="openAddTaskModal('bathroom','Planning')" aria-label="Add tasks to Bathroom Update Epic">
                                    Add Tasks
                                </button>
                            </div>
                        </article>
                    </div>
                </section>

                <!-- Sidebar Widgets -->
                <aside class="sidebar-widgets" aria-label="Dashboard widgets">
                    <!-- Recent Activity Widget -->
                    <section class="widget recent-activity" aria-labelledby="activity-heading">
                        <h3 id="activity-heading">Recent Activity</h3>

                        <ul class="activity-list" id="activityListContainer">
                            <li class="activity-item"
                                role="button"
                                tabindex="0"
                                onclick="viewActivityDetail('1')"
                                onkeypress="handleKeyPress(event, 'viewActivityDetail', '1')">
                                <span class="activity-icon" aria-hidden="true">üß∞</span>
                                <div class="activity-text">
                                    <div class="activity-title">Added task ‚ÄúInstall backsplash‚Äù to Kitchen</div>
                                    <time class="activity-time" datetime="2025-10-12T14:00:00">2 hours ago</time>
                                </div>
                            </li>

                            <li class="activity-item"
                                role="button"
                                tabindex="0"
                                onclick="viewActivityDetail('2')"
                                onkeypress="handleKeyPress(event, 'viewActivityDetail', '2')">
                                <span class="activity-icon" aria-hidden="true">‚úÖ</span>
                                <div class="activity-text">
                                    <div class="activity-title">Marked ‚ÄúOrder tile‚Äù as Done</div>
                                    <time class="activity-time" datetime="2025-10-12T12:00:00">4 hours ago</time>
                                </div>
                            </li>

                            <li class="activity-item"
                                role="button"
                                tabindex="0"
                                onclick="viewActivityDetail('3')"
                                onkeypress="handleKeyPress(event, 'viewActivityDetail', '3')">
                                <span class="activity-icon" aria-hidden="true">üìé</span>
                                <div class="activity-text">
                                    <div class="activity-title">Uploaded ‚ÄúElectrical permit approval‚Äù</div>
                                    <time class="activity-time" datetime="2025-10-12T10:00:00">6 hours ago</time>
                                </div>
                            </li>
                        </ul>
                    </section>

                    <!-- Upcoming Tasks Widget -->
                    <section class="widget upcoming-tasks" aria-labelledby="tasks-heading">
                        <h3 id="tasks-heading">Upcoming Tasks</h3>

                        <ul class="task-list" id="upcomingTasksContainer">
                            <li class="task-item priority-high"
                                role="button"
                                tabindex="0"
                                onclick="viewTaskDetail('t9')"
                                onkeypress="handleKeyPress(event, 'viewTaskDetail', 't9')">
                                <span class="task-priority high" aria-label="High priority">!</span>
                                <span class="task-text">Schedule plumbing inspection</span>
                                <time class="task-due" datetime="2025-10-13">Due tomorrow</time>
                            </li>

                            <li class="task-item priority-medium"
                                role="button"
                                tabindex="0"
                                onclick="viewTaskDetail('t11')"
                                onkeypress="handleKeyPress(event, 'viewTaskDetail', 't11')">
                                <span class="task-priority medium" aria-label="Medium priority">‚Ä¢</span>
                                <span class="task-text">Order bathroom vanity</span>
                                <time class="task-due" datetime="2025-10-15">Due Friday</time>
                            </li>

                            <li class="task-item priority-low"
                                role="button"
                                tabindex="0"
                                onclick="viewTaskDetail('t8')"
                                onkeypress="handleKeyPress(event, 'viewTaskDetail', 't8')">
                                <span class="task-priority low" aria-label="Low priority">-</span>
                                <span class="task-text">Research countertop materials</span>
                                <time class="task-due" datetime="2025-10-18">Due next week</time>
                            </li>
                        </ul>
                    </section>

                    <!-- Budget Summary Widget -->
                    <section class="widget budget-summary" aria-labelledby="budget-heading">
                        <h3 id="budget-heading">Budget Overview</h3>

                        <div class="budget-stats">
                            <div class="budget-item">
                                <span class="budget-label">Total Allocated</span>
                                <span class="budget-amount">$75,000</span>
                            </div>

                            <div class="budget-item">
                                <span class="budget-label">Total Spent</span>
                                <span class="budget-amount spent">$36,700</span>
                            </div>

                            <div class="budget-item">
                                <span class="budget-label">Remaining</span>
                                <span class="budget-amount remaining">$38,300</span>
                            </div>
                        </div>

                        <div class="budget-chart">
                            <div class="chart-bar"
                                 role="progressbar"
                                 aria-valuenow="49"
                                 aria-valuemin="0"
                                 aria-valuemax="100"
                                 aria-label="Budget utilization: 49%">
                                <div class="chart-fill" style="width: 49%"></div>
                            </div>
                            <p class="chart-label">49% budget utilized</p>
                        </div>

                        <a href="budget.html" class="btn-link" style="margin-top: var(--space-md); display: inline-block;">
                            View Full Budget ‚Üí
                        </a>
                    </section>
                </aside>
            </div>
        </div>
    </main>

    <!-- Reusable Backdrop & Modal Root -->
    <div id="backdrop" class="modal-backdrop"></div>
    <div id="modalRoot" class="modal" aria-hidden="true"></div>

    <!-- Scripts -->
    <script>
        // ---------- THEME UTIL ----------
        function toast(msg){
          let t = document.getElementById('atlas-toast');
          if(!t){
            t = document.createElement('div');
            t.id='atlas-toast';
            t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b3a75;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:1200;opacity:0;transition:opacity .15s ease';
            document.body.appendChild(t);
          }
          t.textContent = msg;
          t.style.opacity = '1';
          setTimeout(()=>t.style.opacity='0', 1500);
        }

        // ---------- MOBILE NAV ----------
        function toggleMobileMenu() {
            const nav = document.getElementById('mainNav');
            const toggle = document.querySelector('.mobile-menu-toggle');
            const isExpanded = nav.classList.toggle('active');
            toggle.setAttribute('aria-expanded', isExpanded);
        }

        // Keyboard accessibility helper
        function handleKeyPress(event, functionName, id) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                if (typeof window[functionName] === 'function') {
                    if (typeof id !== 'undefined') {
                        window[functionName](id);
                    } else {
                        window[functionName]();
                    }
                }
            }
        }

        // ---------- STORAGE MODEL (aligned with kanban.html) ----------
        const KanbanStore = {
          keyTasks: 'atlas.kanban.tasks',
          keyStatuses: 'atlas.kanban.statuses',
          read(){ try { return JSON.parse(localStorage.getItem(this.keyTasks)) || []; } catch { return []; } },
          write(list){ localStorage.setItem(this.keyTasks, JSON.stringify(list)); },
          ensureSeed(){
            // if kanban has no data, seed with defaults used in kanban.html
            const existing = this.read();
            if(existing.length) return;
            const seed = [
              {id:"t1", title:"Research countertop materials", desc:"Quartz vs granite. Look at Costco & local fabricators.", status:"Someday", project:"kitchen", assignee:"Andrew", priority:"Low",  due:"",          deps:[]},
              {id:"t2", title:"Submit basement permit",       desc:"City of Woodinville online portal",                     status:"Planning", project:"basement", assignee:"Andrew", priority:"High", due:"2025-10-18", deps:[]},
              {id:"t3", title:"Order bathroom vanity",        desc:"36‚Äù oak, matte black hardware ‚Äì Home Depot",           status:"Ready",    project:"bathroom", assignee:"Katie",  priority:"Medium",due:"2025-10-15", deps:[]},
              {id:"t4", title:"Install backsplash",           desc:"Subway tile herringbone. Use leveling clips.",         status:"In Progress", project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-20", deps:["t6"]},
              {id:"t5", title:"Seal grout",                   desc:"After 72 hours, apply two coats.",                     status:"Blocked",  project:"kitchen", assignee:"Andrew", priority:"Low",  due:"",          deps:["t4"]},
              {id:"t6", title:"Countertop template",          desc:"Schedule template after cabinet alignment.",           status:"Done",     project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-10", deps:[]},
            ];
            this.write(seed);
          }
        };
        KanbanStore.ensureSeed();

        function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
        function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m])); }

        // ---------- SIMPLE MODAL (fallback when global atlas modal not present) ----------
        function openBasicModal(title, html, footerHtml){
          const modalRoot = document.getElementById("modalRoot");
          const backdrop  = document.getElementById("backdrop");
          modalRoot.innerHTML = `
            <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${escapeHtml(title)}">
              <div class="modal-header">
                <h3 class="modal-title">${escapeHtml(title)}</h3>
                <button class="modal-close" aria-label="Close" onclick="closeBasicModal()">&times;</button>
              </div>
              <div class="modal-body">${html}</div>
              <div class="modal-footer">${footerHtml || '<button class="btn" onclick="closeBasicModal()">Close</button>'}</div>
            </div>`;
          backdrop.classList.add("show");
          modalRoot.classList.add("open");
          document.body.classList.add("atlas-modal-open");
        }
        function closeBasicModal(){
          const modalRoot = document.getElementById("modalRoot");
          const backdrop  = document.getElementById("backdrop");
          modalRoot.classList.remove("open");
          backdrop.classList.remove("show");
          modalRoot.innerHTML = "";
          document.body.classList.remove("atlas-modal-open");
        }

        // ---------- ROUTING ----------
        function viewProject(projectId) {
            window.location.href = `kanban.html?project=${projectId}`;
        }

        // ---------- NEW PROJECT (fixes: + New Project button did nothing) ----------
        function openBasicNewProject(){
          openBasicModal("Create New Project", `
            <div class="form-grid">
              <label for="np_name">Project Name *</label>
              <input id="np_name" class="input" placeholder="e.g., Kitchen Renovation"/>

              <label for="np_budget">Budget (USD)</label>
              <input id="np_budget" type="number" class="input" placeholder="e.g., 28000"/>

              <div class="form-row">
                <div>
                  <label for="np_status">Initial Status</label>
                  <select id="np_status" class="input">
                    <option>Someday</option>
                    <option>Planning</option>
                    <option selected>Ready</option>
                    <option>In Progress</option>
                    <option>Blocked</option>
                    <option>Done</option>
                  </select>
                </div>
                <div>
                  <label for="np_seed">Seed a starter task?</label>
                  <select id="np_seed" class="input">
                    <option value="yes" selected>Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>
              </div>
            </div>
          `, `
            <button class="btn btn-secondary" onclick="closeBasicModal()">Cancel</button>
            <button class="btn" onclick="createBasicProject()">Create Project</button>
          `);
        }

        function createBasicProject(){
          const name   = document.getElementById('np_name').value.trim();
          const budget = document.getElementById('np_budget').value.trim();
          const status = document.getElementById('np_status').value;
          const seed   = document.getElementById('np_seed').value === 'yes';

          if(!name){ toast("Project name is required."); return; }

          // Store lightweight project list (for future Projects page)
          const key = 'atlas.projects';
          const projects = JSON.parse(localStorage.getItem(key) || '[]');
          const id = slugify(name);
          if(projects.some(p=>p.id===id)){ toast("Project already exists."); return; }

          projects.push({ id, name, budget: budget? Number(budget): null, createdAt: Date.now() });
          localStorage.setItem(key, JSON.stringify(projects));

          // optional seed task so board is not empty
          if(seed){
            const tasks = KanbanStore.read();
            tasks.push({
              id: 't' + Math.random().toString(36).slice(2,7),
              title: 'Kickoff: outline scope',
              desc: 'Define goals, rough budget, and timeline.',
              status: status,
              project: id,
              assignee: 'Andrew',
              priority: 'Medium',
              due: '',
              deps: []
            });
            KanbanStore.write(tasks);
          }

          closeBasicModal();
          toast("Project created.");
          // Navigate straight to the new Kanban board
          viewProject(id);
        }

        // ---------- ADD TASK (fixes: ‚ÄúAdd Tasks‚Äù buttons did nothing) ----------
        function openAddTaskModal(projectId, defaultStatus){
          // Prefer app-level modal if present
          if(window.atlas && typeof window.atlas.showAddTaskModal === 'function'){
            window.atlas.showAddTaskModal(defaultStatus || 'Planning', projectId);
            return;
          }

          openBasicModal("Add Task", `
            <label for="at_title">Title *</label>
            <input id="at_title" class="input" placeholder="e.g., Schedule plumbing inspection"/>

            <label for="at_desc">Description</label>
            <textarea id="at_desc" class="input" placeholder="Add context"></textarea>

            <div class="form-row">
              <div>
                <label for="at_status">Status</label>
                <select id="at_status" class="input">
                  <option ${defaultStatus==='Someday'?'selected':''}>Someday</option>
                  <option ${defaultStatus==='Planning'?'selected':''}>Planning</option>
                  <option ${defaultStatus==='Ready'?'selected':''}>Ready</option>
                  <option ${defaultStatus==='In Progress'?'selected':''}>In Progress</option>
                  <option ${defaultStatus==='Blocked'?'selected':''}>Blocked</option>
                  <option ${defaultStatus==='Done'?'selected':''}>Done</option>
                </select>
              </div>
              <div>
                <label for="at_assignee">Assignee</label>
                <select id="at_assignee" class="input">
                  <option>Andrew</option>
                  <option>Katie</option>
                  <option>Contractor</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div>
                <label for="at_priority">Priority</label>
                <select id="at_priority" class="input">
                  <option>Low</option><option selected>Medium</option><option>High</option>
                </select>
              </div>
              <div>
                <label for="at_due">Due Date</label>
                <input id="at_due" type="date" class="input"/>
              </div>
            </div>
          `, `
            <button class="btn btn-secondary" onclick="closeBasicModal()">Cancel</button>
            <button class="btn" onclick="createTaskFromDashboard('${projectId || ''}')">Create Task</button>
          `);
        }

        function createTaskFromDashboard(projectId){
          const title    = document.getElementById('at_title').value.trim();
          if(!title){ toast("Title is required."); return; }
          const desc     = document.getElementById('at_desc').value.trim();
          const status   = document.getElementById('at_status').value;
          const assignee = document.getElementById('at_assignee').value;
          const priority = document.getElementById('at_priority').value;
          const due      = document.getElementById('at_due').value;

          const tasks = KanbanStore.read();
          tasks.push({
            id: 't' + Math.random().toString(36).slice(2,7),
            title, desc, status, assignee, priority, due,
            deps: [],
            project: projectId || 'general'
          });
          KanbanStore.write(tasks);
          closeBasicModal();
          toast("Task created.");
        }

        // ---------- UPCOMING TASKS CLICK (fixes: Upcoming list did nothing) ----------
        function viewTaskDetail(taskId){
          const listEl = [...document.querySelectorAll('#upcomingTasksContainer .task-item')].find(li =>
            li.getAttribute('onclick')?.includes(`'${taskId}'`));

          const titleFromDom = listEl ? listEl.querySelector('.task-text')?.textContent.trim() : '';

          // Resolve to a task by id OR by title (back-compat)
          const tasks = KanbanStore.read();
          let task = tasks.find(t => t.id === taskId);
          if(!task && titleFromDom){
            task = tasks.find(t => t.title.toLowerCase() === titleFromDom.toLowerCase());
          }

          // If still not found, create a placeholder so the user can immediately edit/save it.
          if(!task){
            task = {
              id: taskId,
              title: titleFromDom || 'Untitled Task',
              desc: '',
              status: 'Ready',
              project: 'kitchen',
              assignee: 'Andrew',
              priority: 'Medium',
              due: (listEl?.querySelector('time')?.getAttribute('datetime')) || '',
              deps: []
            };
            tasks.push(task);
            KanbanStore.write(tasks);
          }

          // Prefer global atlas editor if present
          if(window.atlas && typeof window.atlas.showTaskDetailModal === 'function'){
            window.atlas.showTaskDetailModal(task);
            return;
          }

          // Fallback editor
          openBasicModal("Task Details", `
            <label>Title</label>
            <input id="td_title" class="input" value="${escapeHtml(task.title)}"/>

            <label>Description</label>
            <textarea id="td_desc" class="input">${escapeHtml(task.desc)}</textarea>

            <div class="form-row">
              <div>
                <label>Status</label>
                <select id="td_status" class="input">
                  ${['Someday','Planning','Ready','In Progress','Blocked','Done'].map(s=>`<option ${task.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>Assignee</label>
                <select id="td_assignee" class="input">
                  ${['Andrew','Katie','Contractor'].map(a=>`<option ${task.assignee===a?'selected':''}>${a}</option>`).join('')}
                </select>
              </div>
            </div>

            <div class="form-row">
              <div>
                <label>Priority</label>
                <select id="td_priority" class="input">
                  ${['Low','Medium','High'].map(p=>`<option ${task.priority===p?'selected':''}>${p}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>Due</label>
                <input id="td_due" type="date" class="input" value="${escapeHtml(task.due)}"/>
              </div>
            </div>
          `, `
            <button class="btn btn-secondary" onclick="closeBasicModal()">Close</button>
            <button class="btn btn-secondary" onclick="openTaskOnBoard('${task.project||'general'}')">Open on Board</button>
            <button class="btn" onclick="saveTaskEdits('${task.id}')">Save Changes</button>
          `);
        }

        function saveTaskEdits(id){
          const tasks = KanbanStore.read();
          const idx = tasks.findIndex(t => t.id === id);
          if(idx === -1){ toast("Task not found."); return; }
          tasks[idx].title    = document.getElementById('td_title').value.trim() || tasks[idx].title;
          tasks[idx].desc     = document.getElementById('td_desc').value.trim();
          tasks[idx].status   = document.getElementById('td_status').value;
          tasks[idx].assignee = document.getElementById('td_assignee').value;
          tasks[idx].priority = document.getElementById('td_priority').value;
          tasks[idx].due      = document.getElementById('td_due').value;
          KanbanStore.write(tasks);
          toast("Task updated.");
          closeBasicModal();
        }

        function openTaskOnBoard(projectId){
          // Navigate to Kanban board filtered by project
          closeBasicModal();
          viewProject(projectId || 'general');
        }

        // ---------- ACTIVITY (simple preview) ----------
        function viewActivityDetail(id){
          const items = {
            "1": { title:"Install backsplash", project:"kitchen", status:"In Progress" },
            "2": { title:"Order tile", project:"kitchen", status:"Done" },
            "3": { title:"Electrical permit approval", project:"kitchen", status:"Done" }
          };
          const a = items[id] || {title:"Activity", project:"general", status:""};
          openBasicModal("Activity", `
            <p><strong>${escapeHtml(a.title)}</strong></p>
            <p>Project: ${escapeHtml(a.project)}</p>
            <p>Status: ${escapeHtml(a.status)}</p>
          `, `
            <button class="btn btn-secondary" onclick="closeBasicModal()">Close</button>
            <button class="btn" onclick="viewProject('${a.project}')">Open Project Board</button>
          `);
        }

        // ---------- INIT: Upgrade "Add Tasks" buttons to call our modal if atlas not loaded ----------
        (function initWiring(){
          // Replace any legacy onclick that expected atlas.showAddTaskModal
          document.querySelectorAll('.project-card .project-actions .btn-link').forEach(btn=>{
            if(btn.textContent.trim() === 'Add Tasks' && !btn.getAttribute('onclick')?.includes('openAddTaskModal')){
              const article = btn.closest('.project-card');
              const projectId = article?.getAttribute('data-project-id') || 'general';
              btn.setAttribute('onclick', `openAddTaskModal('${projectId}','Planning')`);
            }
          });
        })();
    </script>
</body>
</html>
