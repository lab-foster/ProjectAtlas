<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Project Calendar - Schedule and track deadlines, inspections, and milestones for your home improvement projects"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Calendar - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">

  <!-- Global Styles -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* ---- Calendar page specific styles (preserving original palette & feel) ---- */
    .calendar-main{padding:var(--space-xl);max-width:1600px;margin:0 auto}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-xl);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-default);gap:var(--space-lg);flex-wrap:wrap}
    .calendar-title h2{margin-bottom:var(--space-xs);font-size:1.5rem}
    .current-month{color:var(--text-secondary);font-size:.9375rem;font-weight:500}
    .calendar-controls{display:flex;gap:var(--space-sm);align-items:center}
    .nav-btn{width:36px;height:36px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md);font-size:1.25rem;cursor:pointer;transition:all var(--transition-fast);display:flex;align-items:center;justify-content:center}
    .nav-btn:hover{background:var(--app-primary-lighter);border-color:var(--app-primary);color:var(--app-primary)}
    .today-btn{padding:var(--space-sm) var(--space-lg);border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md);font-weight:500;cursor:pointer;transition:all var(--transition-fast)}
    .today-btn:hover{background:var(--app-primary);border-color:var(--app-primary);color:#fff}
    .view-controls{display:flex;gap:var(--space-md);align-items:center}
    .filter-select{padding:var(--space-sm) var(--space-md);border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-secondary);color:var(--text-primary);font-size:.9375rem;font-family:inherit;cursor:pointer;transition:all var(--transition-fast)}
    .filter-select:hover{border-color:var(--border-medium)}
    .filter-select:focus{outline:none;border-color:var(--app-primary);box-shadow:0 0 0 3px var(--app-primary-light)}
    .view-toggle{display:flex;border:1px solid var(--border-default);border-radius:var(--radius-md);overflow:hidden}
    .view-btn{padding:var(--space-sm) var(--space-md);background:var(--bg-secondary);color:var(--text-secondary);border:none;border-right:1px solid var(--border-default);cursor:pointer;transition:all var(--transition-fast);font-weight:500;font-size:.875rem}
    .view-btn:last-child{border-right:none}
    .view-btn:hover{background:var(--app-primary-lighter);color:var(--app-primary)}
    .view-btn.active{background:var(--app-primary);color:#fff}

    .calendar-container{display:grid;grid-template-columns:1fr 350px;gap:var(--space-xl)}
    .calendar-grid{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:var(--space-lg);box-shadow:var(--shadow-sm)}
    .calendar-grid .calendar-header-row{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:var(--space-sm)}
    .day-header{text-align:center;font-weight:600;color:var(--text-secondary);font-size:.875rem;padding:var(--space-sm);text-transform:uppercase;letter-spacing:.05em}

    /* Month grid cells */
    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border-light)}
    .calendar-day{background:var(--bg-secondary);min-height:120px;padding:var(--space-sm);position:relative;transition:all var(--transition-fast);cursor:pointer}
    .calendar-day:hover{background:var(--app-primary-lighter)}
    .calendar-day.other-month{background:var(--gray-100);opacity:.5}
    .calendar-day.today{background:var(--app-primary-lighter);border:2px solid var(--app-primary)}
    .day-number{font-weight:600;color:var(--text-primary);font-size:.875rem;margin-bottom:var(--space-xs)}
    .calendar-day.other-month .day-number{color:var(--text-tertiary)}
    .calendar-day.today .day-number{color:var(--app-primary)}
    .day-indicator{position:absolute;top:var(--space-xs);right:var(--space-xs);font-size:.625rem;font-weight:700;color:var(--app-primary);text-transform:uppercase;letter-spacing:.05em}

    .event{background:var(--app-primary);color:#fff;padding:var(--space-xs) var(--space-sm);border-radius:var(--radius-sm);margin-bottom:var(--space-xs);cursor:pointer;transition:all var(--transition-fast)}
    .event:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
    .event.kitchen{background:#2196f3}
    .event.bathroom{background:#ff9800}
    .event.basement{background:#4caf50}
    .event.deadline{background:var(--status-error);font-weight:600}
    .event-title{font-size:.75rem;font-weight:500;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .more-pill{display:inline-block;background:var(--bg-elevated);border:1px dashed var(--border-default);color:var(--text-secondary);border-radius:999px;font-size:.7rem;padding:2px 6px}

    /* Week / Day agenda */
    .agenda{display:grid;grid-template-columns:120px 1fr;gap:var(--space-md)}
    .agenda-hours{display:flex;flex-direction:column;gap:18px;color:var(--text-tertiary);font-size:.8125rem}
    .agenda-slots{position:relative;border-left:1px solid var(--border-light);padding-left:var(--space-md)}
    .slot{position:relative;margin:8px 0}
    .slot .event{display:inline-block}

    /* Sidebar */
    .calendar-sidebar{display:flex;flex-direction:column;gap:var(--space-xl)}
    .upcoming-events,.calendar-legend,.calendar-stats{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:var(--space-lg);box-shadow:var(--shadow-sm)}
    .upcoming-events h3,.calendar-legend h3,.calendar-stats h3{font-size:1rem;margin-bottom:var(--space-md);color:var(--text-primary);font-weight:600}
    .event-list{display:flex;flex-direction:column;gap:var(--space-md)}
    .upcoming-event{padding:var(--space-md);border:1px solid var(--border-light);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast)}
    .upcoming-event:hover{background:var(--app-primary-lighter);border-color:var(--app-primary-light);transform:translateY(-1px)}
    .upcoming-event.high-priority{border-left:4px solid var(--status-error)}
    .upcoming-event.medium-priority{border-left:4px solid var(--status-warning)}
    .upcoming-event.low-priority{border-left:4px solid var(--status-success)}
    .event-date{font-size:.8125rem;color:var(--text-tertiary);font-weight:500;margin-bottom:var(--space-xs)}
    .event-name{font-weight:600;color:var(--text-primary);margin-bottom:var(--space-xs);font-size:.9375rem}
    .event-project{font-size:.75rem;padding:var(--space-xs) var(--space-sm);border-radius:var(--radius-full);display:inline-block;font-weight:600}
    .event-project.kitchen{background:rgba(33,150,243,.12);color:#2196f3}
    .event-project.bathroom{background:rgba(255,152,0,.12);color:#ff9800}
    .event-project.basement{background:rgba(76,175,80,.12);color:#4caf50}

    .legend-items{display:flex;flex-direction:column;gap:var(--space-md)}
    .legend-item{display:flex;align-items:center;gap:var(--space-md)}
    .legend-color{width:20px;height:20px;border-radius:var(--radius-sm);flex-shrink:0}
    .legend-color.kitchen{background:#2196f3}
    .legend-color.bathroom{background:#ff9800}
    .legend-color.basement{background:#4caf50}
    .legend-color.deadline{background:var(--status-error)}
    .legend-label{font-size:.875rem;color:var(--text-primary)}

    .stat-item{display:flex;justify-content:space-between;padding:var(--space-sm) 0;border-bottom:1px solid var(--border-light)}
    .stat-item:last-child{border-bottom:none}
    .stat-label{color:var(--text-secondary);font-size:.875rem}
    .stat-value{color:var(--text-primary);font-weight:700;font-size:.875rem}

    /* Modal (fallback: mirrors dashboard‚Äôs modal style) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1000}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1001}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-panel{width:min(720px,92vw);max-height:86vh;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:flex;flex-direction:column;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--border-light)}
    .modal-title{font-size:1.125rem}
    .modal-close{background:transparent;border:0;font-size:1.5rem;cursor:pointer;color:var(--text-secondary)}
    .modal-body{padding:16px 18px;overflow:auto}
    .modal-footer{padding:12px 18px;border-top:1px solid var(--border-light);display:flex;gap:10px;justify-content:flex-end}
    .input,.textarea, .input[type="date"], .input[type="time"], .input[type="datetime-local"], select.input{width:100%;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:8px;padding:10px}
    .form-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    @media(max-width:1200px){.calendar-container{grid-template-columns:1fr 300px}}
    @media(max-width:1024px){
      .calendar-container{grid-template-columns:1fr}
      .calendar-sidebar{order:-1;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    }
    @media(max-width:768px){
      .calendar-main{padding:var(--space-lg)}
      .calendar-header{flex-direction:column;align-items:stretch;text-align:center}
      .calendar-controls{justify-content:center}
      .view-controls{flex-direction:column}
      .filter-select,.view-toggle{width:100%}
      .calendar-day{min-height:90px;font-size:.8125rem}
      .event-title{font-size:.6875rem}
      .calendar-sidebar{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
    }
    @media(max-width:480px){
      .calendar-main{padding:var(--space-md)}
      .calendar-grid{padding:var(--space-sm)}
      .calendar-day{min-height:80px;padding:var(--space-xs)}
      .day-number{font-size:.75rem}
      .upcoming-events,.calendar-legend,.calendar-stats{padding:var(--space-md)}
    }
  </style>
</head>
<body class="app-page">
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <!-- Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mainNav">
        <span aria-hidden="true">‚ò∞</span>
      </button>

      <nav class="main-nav" id="mainNav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html" class="active" aria-current="page">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu">
        <button class="btn btn-secondary" onclick="openAddEventModal()" aria-label="Schedule new task"><span aria-hidden="true">+</span> Schedule Task</button>
        <button class="user-avatar" onclick="showUserMenu()" aria-label="User menu" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="calendar-main" id="main-content">
    <div class="calendar-header">
      <div class="calendar-title">
        <h2>Project Calendar</h2>
        <time class="current-month" id="monthLabel" datetime=""></time>
      </div>

      <div class="calendar-controls" role="group" aria-label="Calendar navigation">
        <button class="nav-btn" onclick="previousMonth()" aria-label="Previous month"><span aria-hidden="true">‚Äπ</span></button>
        <button class="today-btn" onclick="goToToday()" aria-label="Go to today">Today</button>
        <button class="nav-btn" onclick="nextMonth()" aria-label="Next month"><span aria-hidden="true">‚Ä∫</span></button>
      </div>

      <div class="view-controls" role="group" aria-label="View options">
        <label for="projectFilterCalendar" class="sr-only">Filter by project</label>
        <select class="filter-select" id="projectFilterCalendar" aria-label="Filter by project" onchange="handleProjectFilter(this.value)">
          <option value="all">All Projects</option>
          <option value="kitchen">Kitchen Renovation</option>
          <option value="basement">Basement Finishing</option>
          <option value="bathroom">Bathroom Update</option>
        </select>

        <div class="view-toggle" role="radiogroup" aria-label="Calendar view">
          <button class="view-btn active" role="radio" aria-checked="true" onclick="changeView('month', event)">Month</button>
          <button class="view-btn" role="radio" aria-checked="false" onclick="changeView('week', event)">Week</button>
          <button class="view-btn" role="radio" aria-checked="false" onclick="changeView('day', event)">Day</button>
        </div>
      </div>
    </div>

    <div class="calendar-container">
      <!-- Calendar Grid (dynamic) -->
      <section class="calendar-grid" aria-live="polite">
        <div class="calendar-header-row" role="row">
          <div class="day-header" role="columnheader">Sun</div>
          <div class="day-header" role="columnheader">Mon</div>
          <div class="day-header" role="columnheader">Tue</div>
          <div class="day-header" role="columnheader">Wed</div>
          <div class="day-header" role="columnheader">Thu</div>
          <div class="day-header" role="columnheader">Fri</div>
          <div class="day-header" role="columnheader">Sat</div>
        </div>
        <div id="calendarViewRoot" class="month-grid" role="grid" aria-label=""></div>
      </section>

      <!-- Sidebar -->
      <aside class="calendar-sidebar" aria-label="Calendar information">
        <section class="upcoming-events" aria-labelledby="upcoming-heading">
          <h3 id="upcoming-heading">Upcoming This Week</h3>
          <div id="upcomingList" class="event-list"></div>
        </section>

        <section class="calendar-legend" aria-labelledby="legend-heading">
          <h3 id="legend-heading">Project Color Key</h3>
          <div class="legend-items">
            <div class="legend-item"><div class="legend-color kitchen" aria-hidden="true"></div><span class="legend-label">Kitchen Renovation</span></div>
            <div class="legend-item"><div class="legend-color bathroom" aria-hidden="true"></div><span class="legend-label">Bathroom Update</span></div>
            <div class="legend-item"><div class="legend-color basement" aria-hidden="true"></div><span class="legend-label">Basement Finishing</span></div>
            <div class="legend-item"><div class="legend-color deadline" aria-hidden="true"></div><span class="legend-label">Deadlines & Milestones</span></div>
          </div>
        </section>

        <section class="calendar-stats" aria-labelledby="stats-heading">
          <h3 id="stats-heading">This Month</h3>
          <div class="stat-item"><span class="stat-label">Total Events</span><span id="statTotal" class="stat-value">0</span></div>
          <div class="stat-item"><span class="stat-label">Inspections</span><span id="statInspections" class="stat-value">0</span></div>
          <div class="stat-item"><span class="stat-label">Deadlines</span><span id="statDeadlines" class="stat-value">0</span></div>
          <div class="stat-item"><span class="stat-label">Contractor Meetings</span><span id="statMeetings" class="stat-value">0</span></div>
        </section>
      </aside>
    </div>
  </main>

  <!-- Reusable Backdrop & Modal Root (fallback) -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <script>
    /* ---------------- Mobile nav (shared behavior) ---------------- */
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const toggle = document.querySelector('.mobile-menu-toggle');
      const isExpanded = nav.classList.toggle('active');
      toggle.setAttribute('aria-expanded', isExpanded);
    }
    function showUserMenu(){
      if(window.atlas && typeof window.atlas.showUserMenu === 'function'){ window.atlas.showUserMenu(); }
    }
    function handleKeyPress(event, fnName, arg){
      if(event.key === 'Enter' || event.key === ' '){
        event.preventDefault();
        const fn = window[fnName];
        if(typeof fn === 'function'){ typeof arg !== 'undefined' ? fn(arg) : fn(); }
      }
    }

    /* ---------------- Utils ---------------- */
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Los_Angeles';
    const fmtMonth = new Intl.DateTimeFormat(undefined,{month:'long',year:'numeric',timeZone:tz});
    const fmtDayShort = new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'numeric',timeZone:tz});
    const fmtDateISO = (d)=> new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const parseISO = (s)=>{ const d = new Date(s); return isNaN(d)? null : d; };
    const pad = (n)=> String(n).padStart(2,'0');
    function startOfWeek(d){ const x = new Date(d); x.setHours(0,0,0,0); const delta = x.getDay(); x.setDate(x.getDate()-delta); return x; }
    function endOfWeek(d){ const s = startOfWeek(d); const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
    function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    function toast(msg){
      let t = document.getElementById('atlas-toast');
      if(!t){
        t = document.createElement('div');
        t.id='atlas-toast';
        t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b3a75;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:1200;opacity:0;transition:opacity .15s ease';
        document.body.appendChild(t);
      }
      t.textContent = msg; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 1400);
    }

    /* ---------------- Modal (fallback if atlas modal not present) ---------------- */
    function openModal(title, html, footerHtml){
      if(window.atlas && typeof window.atlas.openModal === 'function'){ window.atlas.openModal(title, html, footerHtml); return; }
      const modalRoot = document.getElementById("modalRoot");
      const backdrop  = document.getElementById("backdrop");
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${title.replace(/"/g,'&quot;')}">
          <div class="modal-header">
            <h3 class="modal-title">${title}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">${html}</div>
          <div class="modal-footer">${footerHtml || '<button class="btn" onclick="closeModal()">Close</button>'}</div>
        </div>`;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }
    function closeModal(){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop  = document.getElementById("backdrop");
      modalRoot.classList.remove("open");
      backdrop.classList.remove("show");
      modalRoot.innerHTML = "";
      document.body.classList.remove("atlas-modal-open");
    }

    /* ---------------- Calendar Store ---------------- */
    const CalendarStore = {
      key: 'atlas.calendar.events',
      read(){ try{ return JSON.parse(localStorage.getItem(this.key))||[]; }catch{ return []; } },
      write(list){ localStorage.setItem(this.key, JSON.stringify(list)); },
      ensureSeed(){
        const have = this.read();
        if(have.length) return;
        // Seed from the original mock (dates adapted to November 2024)
        const seed = [
          {id:"evt-1", title:"Material delivery",      project:"kitchen",  type:"work", start:"2024-11-02", allDay:true, notes:""},
          {id:"evt-2", title:"Contractor meeting",     project:"basement", type:"meeting", start:"2024-11-04T10:00", end:"2024-11-04T11:00", allDay:false, notes:"Scope review"},
          {id:"evt-3", title:"Plumbing inspection",    project:"bathroom", type:"inspection", start:"2024-11-06T13:00", end:"2024-11-06T14:00", allDay:false, notes:"City inspector"},
          {id:"evt-4", title:"Backsplash work",        project:"kitchen",  type:"work", start:"2024-11-09", end:"2024-11-10", allDay:true, notes:"Herringbone pattern"},
          {id:"evt-5", title:"Permit application",     project:"basement", type:"milestone", start:"2024-11-12", allDay:true, notes:"Submit online"},
          {id:"evt-6", title:"Vanity installation",    project:"bathroom", type:"work", start:"2024-11-14", allDay:true, notes:"Matte black hardware"},
          {id:"evt-7", title:"Final kitchen cleanup",  project:"kitchen",  type:"work", start:"2024-11-18", allDay:true, notes:"Deep clean"},
          {id:"evt-8", title:"Material shopping",      project:"basement", type:"work", start:"2024-11-23", allDay:true, notes:"Framing supplies"},
          {id:"evt-9", title:"Kitchen project deadline", project:"kitchen", type:"deadline", start:"2024-11-25", allDay:true, notes:"Close out"},
          {id:"evt-10",title:"Basement work begins",   project:"basement", type:"work", start:"2024-11-30", allDay:true, notes:"Framing day 1"},
        ];
        this.write(seed);
      }
    };
    CalendarStore.ensureSeed();

    /* ---------------- State ---------------- */
    const state = {
      view: 'month', // 'month' | 'week' | 'day'
      cursor: new Date(),          // date anchor for month/week/day
      projectFilter: 'all',
    };

    /* ---------------- Rendering ---------------- */
    const elMonthLabel = document.getElementById('monthLabel');
    const elViewRoot   = document.getElementById('calendarViewRoot');
    const elUpcoming   = document.getElementById('upcomingList');

    function setMonthLabel(d){
      elMonthLabel.textContent = fmtMonth.format(d);
      elMonthLabel.setAttribute('datetime', d.toISOString().slice(0,7));
      const ariaLabel = state.view === 'month'
        ? `${fmtMonth.format(d)} calendar`
        : state.view === 'week'
          ? `Week of ${fmtDayShort.format(startOfWeek(d))}`
          : `Agenda for ${fmtDayShort.format(d)}`;
      elViewRoot.setAttribute('aria-label', ariaLabel);
    }

    function filterByProject(evts){
      if(state.projectFilter === 'all') return evts;
      return evts.filter(e => e.project === state.projectFilter);
    }

    function eventsInRange(start, end){
      const evts = filterByProject(CalendarStore.read());
      return evts.filter(e=>{
        const s = parseISO(e.start);
        const eend = e.end ? parseISO(e.end) : (e.allDay ? new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59,999) : s);
        return (s <= end && eend >= start);
      }).sort((a,b)=> new Date(a.start) - new Date(b.start));
    }

    function projectClass(p){ return p === 'kitchen' ? 'kitchen' : p === 'bathroom' ? 'bathroom' : p === 'basement' ? 'basement' : ''; }
    function typeIs(o,t){ return (o.type||'').toLowerCase()===t; }

    function render(){
      setMonthLabel(state.cursor);
      if(state.view==='month'){ renderMonth(); }
      else if(state.view==='week'){ renderWeek(); }
      else { renderDay(); }
      renderUpcoming();
      renderStats();
    }

    /* ---- Month view ---- */
    function renderMonth(){
      elViewRoot.className = 'month-grid';
      elViewRoot.innerHTML = '';
      const first = startOfMonth(state.cursor);
      const start = startOfWeek(first);
      const cells = 42; // 6 weeks grid
      const todayISO = fmtDateISO(new Date());

      for(let i=0;i<cells;i++){
        const d = new Date(start); d.setDate(d.getDate()+i);
        const isOther = d.getMonth()!==state.cursor.getMonth();
        const dayISO = fmtDateISO(d);

        const cell = document.createElement('div');
        cell.className = 'calendar-day' + (isOther?' other-month':'') + (dayISO===todayISO?' today':'');
        cell.setAttribute('role','gridcell');
        cell.setAttribute('aria-label', d.toDateString());
        cell.tabIndex = 0;
        cell.onclick = ()=> openDayModal(d);
        cell.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openDayModal(d);} };

        const num = document.createElement('div');
        num.className = 'day-number';
        num.textContent = d.getDate();
        cell.appendChild(num);

        if(dayISO===todayISO){
          const t = document.createElement('div');
          t.className = 'day-indicator';
          t.textContent = 'Today';
          cell.appendChild(t);
        }

        // Events for the day
        const evts = eventsInRange(new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0),
                                   new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999))
                      .filter(e => e.allDay || new Date(e.start).toDateString() === d.toDateString());

        const maxShow = 3;
        evts.slice(0,maxShow).forEach(e=>{
          const btn = document.createElement('div');
          btn.className = `event ${projectClass(e.project)} ${typeIs(e,'deadline')?'deadline':''}`;
          btn.setAttribute('role','button');
          btn.tabIndex = 0;
          btn.onclick = (ev)=>{ ev.stopPropagation(); showEventDetails(e.id); };
          btn.onkeydown=(ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); ev.stopPropagation(); showEventDetails(e.id);} };
          btn.innerHTML = `<div class="event-title">${e.title}</div>`;
          cell.appendChild(btn);
        });

        if(evts.length>maxShow){
          const more = document.createElement('span');
          more.className = 'more-pill';
          more.textContent = `+${evts.length-maxShow} more`;
          more.onclick = (ev)=>{ ev.stopPropagation(); openDayModal(d); };
          cell.appendChild(more);
        }

        elViewRoot.appendChild(cell);
      }
    }

    /* ---- Week view ---- */
    function renderWeek(){
      const weekStart = startOfWeek(state.cursor);
      const weekEnd   = endOfWeek(state.cursor);
      elViewRoot.className = 'month-grid'; // keep card chrome; inside, we render seven columns
      elViewRoot.innerHTML = '';

      for(let i=0;i<7;i++){
        const d = new Date(weekStart); d.setDate(d.getDate()+i);
        const col = document.createElement('div');
        col.className = 'calendar-day';
        col.setAttribute('role','gridcell');
        col.onclick = ()=> openDayModal(d);

        const head = document.createElement('div');
        head.className = 'day-number';
        head.textContent = fmtDayShort.format(d);
        col.appendChild(head);

        const list = document.createElement('div');
        const todays = eventsInRange(new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0),
                                     new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999));
        todays.forEach(e=>{
          const btn = document.createElement('div');
          btn.className = `event ${projectClass(e.project)} ${typeIs(e,'deadline')?'deadline':''}`;
          btn.setAttribute('role','button');
          btn.onclick = (ev)=>{ ev.stopPropagation(); showEventDetails(e.id); };
          const timeLabel = e.allDay ? 'All day' : new Date(e.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          btn.innerHTML = `<div class="event-title">${timeLabel} ‚Ä¢ ${e.title}</div>`;
          list.appendChild(btn);
        });
        col.appendChild(list);
        elViewRoot.appendChild(col);
      }
    }

    /* ---- Day view ---- */
    function renderDay(){
      elViewRoot.className = 'agenda';
      elViewRoot.innerHTML = '';

      const hours = Array.from({length:13},(_,i)=> i+7); // 7:00 - 19:00
      const colHours = document.createElement('div');
      colHours.className = 'agenda-hours';
      hours.forEach(h=>{
        const div = document.createElement('div'); div.textContent = `${pad(h)}:00`; colHours.appendChild(div);
      });

      const colSlots = document.createElement('div');
      colSlots.className = 'agenda-slots';

      const dayStart = new Date(state.cursor.getFullYear(),state.cursor.getMonth(),state.cursor.getDate(),0,0,0,0);
      const dayEnd   = new Date(state.cursor.getFullYear(),state.cursor.getMonth(),state.cursor.getDate(),23,59,59,999);
      const todays = eventsInRange(dayStart, dayEnd);

      if(!todays.length){
        const empty = document.createElement('p');
        empty.className='text-tertiary';
        empty.textContent = 'No events for today.';
        colSlots.appendChild(empty);
      }else{
        todays.forEach(e=>{
          const slot = document.createElement('div'); slot.className='slot';
          const label = e.allDay ? 'All day' : new Date(e.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          slot.innerHTML = `<span class="event ${projectClass(e.project)} ${typeIs(e,'deadline')?'deadline':''}"><span class="event-title">${label} ‚Ä¢ ${e.title}</span></span>`;
          slot.onclick = ()=> showEventDetails(e.id);
          colSlots.appendChild(slot);
        });
      }

      elViewRoot.appendChild(colHours);
      elViewRoot.appendChild(colSlots);
    }

    /* ---- Sidebar: upcoming week ---- */
    function renderUpcoming(){
      elUpcoming.innerHTML = '';
      const now = new Date();
      const start = startOfWeek(now);
      const end   = endOfWeek(now);
      const items = eventsInRange(start, end).slice(0, 7);

      if(!items.length){
        elUpcoming.innerHTML = `<p class="text-tertiary">No events scheduled this week.</p>`;
        return;
      }

      items.forEach(e=>{
        const when = e.allDay ? new Date(e.start) : new Date(e.start);
        const priClass = typeIs(e,'deadline') ? 'high-priority' : (e.type==='inspection' ? 'medium-priority' : 'low-priority');
        const art = document.createElement('article');
        art.className = `upcoming-event ${priClass}`;
        art.setAttribute('role','button');
        art.tabIndex = 0;
        art.onclick = ()=> showEventDetails(e.id);
        art.onkeydown = (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); showEventDetails(e.id);} };
        art.innerHTML = `
          <time class="event-date" datetime="${fmtDateISO(when)}">${fmtDayShort.format(when)}</time>
          <div class="event-name">${e.title}</div>
          <span class="event-project ${projectClass(e.project)}">${titleCase(e.project||'General')}</span>
        `;
        elUpcoming.appendChild(art);
      });
    }

    function titleCase(s){ return (s||'').replace(/\b\w/g,c=>c.toUpperCase()); }

    /* ---- Stats (this month) ---- */
    function renderStats(){
      const mStart = startOfMonth(state.cursor);
      const mEnd   = endOfMonth(state.cursor);
      const list = eventsInRange(mStart,mEnd);
      const total = list.length;
      const inspections = list.filter(e=> e.type==='inspection').length;
      const deadlines   = list.filter(e=> e.type==='deadline').length;
      const meetings    = list.filter(e=> e.type==='meeting').length;

      document.getElementById('statTotal').textContent = String(total);
      document.getElementById('statInspections').textContent = String(inspections);
      document.getElementById('statDeadlines').textContent = String(deadlines);
      document.getElementById('statMeetings').textContent = String(meetings);
    }

    /* ---------------- Interactions ---------------- */
    function previousMonth(){ if(state.view!=='month'){ changeView('month'); } state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()-1, 1); render(); }
    function nextMonth(){ if(state.view!=='month'){ changeView('month'); } state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1, 1); render(); }
    function goToToday(){ state.cursor = new Date(); render(); }
    function changeView(view, ev){
      state.view = view;
      document.querySelectorAll('.view-btn').forEach(btn=>{ btn.classList.remove('active'); btn.setAttribute('aria-checked','false'); });
      if(ev && ev.target){ ev.target.classList.add('active'); ev.target.setAttribute('aria-checked','true'); }
      render();
    }
    function handleProjectFilter(v){ state.projectFilter = v; render(); }

    /* ---- Day modal (quick add / list) ---- */
    function openDayModal(dateObj){
      const dateISO = fmtDateISO(dateObj);
      const list = eventsInRange(new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),0,0,0,0),
                                 new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),23,59,59,999));
      const items = list.map(e => `
        <li style="margin-bottom:8px">
          <button class="btn-link" onclick="showEventDetails('${e.id}')">${e.allDay?'All day':new Date(e.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ‚Ä¢ ${e.title}</button>
          <span class="event-project ${projectClass(e.project)}" style="margin-left:8px">${titleCase(e.project||'General')}</span>
        </li>`).join('') || `<li class="text-tertiary">No events.</li>`;

      openModal(fmtDayShort.format(dateObj),
        `<ul>${items}</ul>`,
        `
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          <button class="btn" onclick="(closeModal(), openAddEventModal('${dateISO}'))">Add Event</button>
        `
      );
    }

    /* ---- Add / Edit Events ---- */
    function openAddEventModal(prefillDate){
      const d = prefillDate || fmtDateISO(state.cursor);
      const defaultTime = '09:00';
      openModal('Schedule Task / Event', `
        <div class="form-grid">
          <label for="ev_title">Title *</label>
          <input id="ev_title" class="input" placeholder="e.g., Schedule plumbing inspection"/>
          <div class="form-row">
            <div>
              <label for="ev_project">Project</label>
              <select id="ev_project" class="input">
                <option value="kitchen">Kitchen Renovation</option>
                <option value="basement">Basement Finishing</option>
                <option value="bathroom">Bathroom Update</option>
              </select>
            </div>
            <div>
              <label for="ev_type">Type</label>
              <select id="ev_type" class="input">
                <option value="work">Work</option>
                <option value="meeting">Meeting</option>
                <option value="inspection">Inspection</option>
                <option value="deadline">Deadline</option>
                <option value="milestone">Milestone</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="ev_date">Date</label>
              <input id="ev_date" type="date" class="input" value="${d}"/>
            </div>
            <div>
              <label for="ev_allDay">All Day?</label>
              <select id="ev_allDay" class="input">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div id="ev_timeRow" class="form-row" style="display:none">
            <div>
              <label for="ev_time">Start</label>
              <input id="ev_time" type="time" class="input" value="${defaultTime}"/>
            </div>
            <div>
              <label for="ev_time_end">End</label>
              <input id="ev_time_end" type="time" class="input" value="10:00"/>
            </div>
          </div>
          <label for="ev_notes">Notes</label>
          <textarea id="ev_notes" class="input" placeholder="Additional context"></textarea>
        </div>
        <script>
          (function(){
            const sel = document.getElementById('ev_allDay');
            const row = document.getElementById('ev_timeRow');
            function toggle(){ row.style.display = sel.value==='no' ? '' : 'none'; }
            sel.addEventListener('change', toggle); toggle();
          })();
        </script>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="createEventFromModal()">Create</button>
      `);
    }

    function createEventFromModal(){
      const title = document.getElementById('ev_title').value.trim();
      if(!title){ toast('Title is required.'); return; }
      const project = document.getElementById('ev_project').value;
      const type    = document.getElementById('ev_type').value;
      const date    = document.getElementById('ev_date').value;
      const allDay  = document.getElementById('ev_allDay').value === 'yes';
      const time    = (document.getElementById('ev_time')||{}).value || '';
      const timeEnd = (document.getElementById('ev_time_end')||{}).value || '';
      const notes   = document.getElementById('ev_notes').value.trim();

      const start = allDay ? date : `${date}T${time||'09:00'}`;
      const end   = allDay ? null : (timeEnd ? `${date}T${timeEnd}` : null);

      const list = CalendarStore.read();
      const id = 'evt-' + Math.random().toString(36).slice(2,8);
      list.push({ id, title, project, type, start, end, allDay, notes });
      CalendarStore.write(list);
      closeModal();
      toast('Event created.');
      render();
    }

    function showEventDetails(id){
      const list = CalendarStore.read();
      const ev = list.find(e=> e.id === id);
      if(!ev){ toast('Event not found.'); return; }
      const s = parseISO(ev.start);
      const dStr = ev.allDay ? fmtDayShort.format(s) : `${fmtDayShort.format(s)} ‚Ä¢ ${s.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}${ev.end? ' - ' + new Date(ev.end).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}`;

      openModal('Event Details', `
        <div class="form-grid">
          <div class="text-tertiary">Project</div>
          <div><span class="event-project ${projectClass(ev.project)}">${titleCase(ev.project)}</span></div>

          <label for="ed_title">Title</label>
          <input id="ed_title" class="input" value="${(ev.title||'').replace(/"/g,'&quot;')}"/>

          <div class="form-row">
            <div>
              <label for="ed_type">Type</label>
              <select id="ed_type" class="input">
                ${['work','meeting','inspection','deadline','milestone'].map(t=>`<option value="${t}" ${ev.type===t?'selected':''}>${titleCase(t)}</option>`).join('')}
              </select>
            </div>
            <div>
              <label for="ed_allDay">All Day?</label>
              <select id="ed_allDay" class="input">
                <option value="yes" ${ev.allDay?'selected':''}>Yes</option>
                <option value="no"  ${!ev.allDay?'selected':''}>No</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="ed_date">Date</label>
              <input id="ed_date" type="date" class="input" value="${fmtDateISO(s)}"/>
            </div>
            <div></div>
          </div>

          <div id="ed_timeRow" class="form-row" style="${ev.allDay?'display:none':''}">
            <div>
              <label for="ed_time">Start</label>
              <input id="ed_time" type="time" class="input" value="${ev.allDay? '' : (pad(s.getHours())+':'+pad(s.getMinutes()))}"/>
            </div>
            <div>
              <label for="ed_time_end">End</label>
              <input id="ed_time_end" type="time" class="input" value="${ev.end? (t=> pad(t.getHours())+':'+pad(t.getMinutes()))(new Date(ev.end)) : ''}"/>
            </div>
          </div>

          <label for="ed_notes">Notes</label>
          <textarea id="ed_notes" class="input">${(ev.notes||'')}</textarea>

          <p class="text-tertiary" style="margin-top:8px">${dStr}</p>
        </div>
        <script>
          (function(){
            const sel = document.getElementById('ed_allDay');
            const row = document.getElementById('ed_timeRow');
            function toggle(){ row.style.display = sel.value==='no' ? '' : 'none'; }
            sel.addEventListener('change', toggle); toggle();
          })();
        </script>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn btn-secondary" onclick="deleteEvent('${ev.id}')">Delete</button>
        <button class="btn" onclick="saveEventEdits('${ev.id}')">Save</button>
      `);
    }

    function saveEventEdits(id){
      const list = CalendarStore.read();
      const i = list.findIndex(e=> e.id === id);
      if(i<0){ toast('Event not found.'); return; }
      const title  = document.getElementById('ed_title').value.trim() || list[i].title;
      const type   = document.getElementById('ed_type').value;
      const allDay = document.getElementById('ed_allDay').value === 'yes';
      const date   = document.getElementById('ed_date').value || fmtDateISO(new Date(list[i].start));
      const t1     = document.getElementById('ed_time')?.value || '';
      const t2     = document.getElementById('ed_time_end')?.value || '';
      const notes  = document.getElementById('ed_notes').value;

      list[i].title = title;
      list[i].type  = type;
      list[i].allDay= allDay;
      list[i].start = allDay ? date : `${date}T${t1||'09:00'}`;
      list[i].end   = allDay ? null : (t2 ? `${date}T${t2}` : null);
      list[i].notes = notes;

      CalendarStore.write(list);
      closeModal();
      toast('Event updated.');
      render();
    }

    function deleteEvent(id){
      const list = CalendarStore.read();
      const next = list.filter(e=> e.id !== id);
      CalendarStore.write(next);
      closeModal();
      toast('Event deleted.');
      render();
    }

    /* ---------------- Init ---------------- */
    (function init(){
      // Default to month view anchored on "today"
      state.cursor = new Date();
      render();
    })();
  </script>

  <!-- Main Interactive Script (if present) -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
