<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Kanban Board - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    :root{
      --overlay: rgba(12,14,18,0.6);
    }

    /* Layout */
    .kanban-main{padding:var(--space-xl);max-width:1440px;margin:0 auto;}
    .kanban-header{
      display:flex;align-items:center;justify-content:space-between;gap:var(--space-lg);
      margin-bottom:var(--space-xl);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-default);
    }
    .board-controls,.board-filters{display:flex;align-items:center;gap:var(--space-md);flex-wrap:wrap;}
    .filter-select{
      padding:var(--space-sm) var(--space-md);border:1px solid var(--border-default);border-radius:var(--radius-md);
      background:var(--bg-secondary);color:var(--text-primary);font-size:.9375rem;font-family:inherit;cursor:pointer;
      transition:all var(--transition-fast);
    }
    .filter-select:hover{border-color:var(--border-medium);}
    .filter-select:focus{outline:none;border-color:var(--app-primary);box-shadow:0 0 0 3px var(--app-primary-light);}

    .kanban-grid{
      display:grid;grid-template-columns:repeat(6,minmax(240px,1fr));gap:var(--space-lg);align-items:start;
    }

    /* Columns */
    .kanban-column{
      background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);display:flex;flex-direction:column;min-height:420px;max-height:80vh;
    }
    .column-header{
      display:flex;align-items:center;justify-content:space-between;gap:var(--space-sm);
      padding:var(--space-md) var(--space-lg);border-bottom:1px solid var(--border-light);
      position:sticky;top:0;background:var(--bg-secondary);z-index:1;border-top-left-radius:var(--radius-lg);border-top-right-radius:var(--radius-lg);
    }
    .column-title{font-weight:600;color:var(--text-primary);display:flex;align-items:center;gap:var(--space-sm);}
    .task-count{
      background:var(--gray-100);color:var(--text-secondary);font-size:.75rem;padding:.125rem .5rem;border-radius:999px;border:1px solid var(--border-light);
    }
    .task-cards{
      padding:var(--space-md);display:flex;flex-direction:column;gap:var(--space-md);flex:1 1 auto;overflow:auto;
    }
    .task-cards.drag-over{outline:2px dashed var(--app-primary);outline-offset:-6px;background:var(--app-primary-lighter);}

    .add-task-wrap{padding:var(--space-md);border-top:1px dashed var(--border-light);}
    .add-task-btn{
      width:100%;background:var(--gray-100);color:var(--text-secondary);border:1px solid var(--border-light);
      border-radius:var(--radius-md);padding:var(--space-sm) var(--space-md);font-size:.875rem;
    }
    .add-task-btn:hover{background:var(--app-primary-lighter);color:var(--app-primary);border-color:var(--app-primary-light);}

    /* Cards */
    .task-card{
      background:var(--white);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:var(--space-md);
      box-shadow:var(--shadow-xs);cursor:grab;user-select:none;opacity:1;transition:transform .12s ease,box-shadow .12s ease,background .12s ease;
    }
    .task-card[aria-grabbed="true"]{cursor:grabbing;transform:scale(.98);box-shadow:var(--shadow-md);}
    .task-title{font-weight:700;color:var(--text-primary);margin-bottom:var(--space-sm);}
    .task-meta{display:flex;justify-content:space-between;gap:var(--space-md);font-size:.8125rem;color:var(--text-secondary);margin-bottom:var(--space-sm);flex-wrap:wrap;}
    .task-labels{display:flex;gap:6px;flex-wrap:wrap;}
    .task-label{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--border-light);background:var(--gray-50);color:var(--text-secondary);}
    .task-due.overdue{color:var(--status-error);font-weight:600;}
    .task-project.kitchen{color:#1976d2;}
    .task-project.basement{color:#4caf50;}
    .task-project.bathroom{color:#ff9800;}

    /* Modal (non-transparent, fixed) */
    .modal-overlay{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;padding:2rem;z-index:999;}
    .modal{width:min(720px,92vw);background:var(--bg-elevated, #fff);border-radius:var(--radius-xl);border:1px solid var(--border-default);box-shadow:var(--shadow-lg);overflow:hidden;}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--border-light);}
    .modal-body{padding:1rem 1.25rem;max-height:60vh;overflow:auto;}
    .modal-actions{display:flex;gap:.75rem;justify-content:flex-end;padding:1rem 1.25rem;border-top:1px solid var(--border-light);background:var(--bg-secondary);}

    .task-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;}
    .task-form label{display:block;font-size:.8125rem;color:var(--text-secondary);margin-bottom:.25rem;}
    .task-form input[type="text"], .task-form textarea, .task-form select{
      width:100%;padding:.625rem .75rem;border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-primary);color:var(--text-primary);
    }
    .task-form textarea{min-height:110px;resize:vertical;}

    /* Columns manager */
    .cols-grid{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:var(--space-md);}
    .cols-row{display:flex;align-items:center;gap:.6rem;padding:.6rem;border:1px solid var(--border-light);border-radius:var(--radius-md);background:var(--gray-50);}
    .cols-row label{font-weight:500;color:var(--text-primary);}

    /* Responsive */
    @media (max-width:1280px){.kanban-grid{grid-template-columns:repeat(3,minmax(240px,1fr));}}
    @media (max-width:880px){.kanban-grid{grid-template-columns:repeat(2,minmax(240px,1fr));}.task-form .form-row{grid-template-columns:1fr;}}
    @media (max-width:560px){.kanban-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body class="app-page">
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <!-- App Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mainNav">
        <span aria-hidden="true">â˜°</span>
      </button>

      <nav class="main-nav" id="mainNav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html" class="active" aria-current="page">Kanban Board</a></li>
          <li><a href="budget.html">Budget</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu">
        <button class="btn btn-secondary" id="quickAddBtn" aria-label="Quick add task"><span aria-hidden="true">+</span> Quick Add</button>
        <button class="user-avatar" onclick="showUserMenu()" aria-label="User menu" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="kanban-main" id="main-content">
    <section class="kanban-header">
      <h2>Kanban Board</h2>
      <div class="board-controls" role="group" aria-label="Board controls">
        <div class="board-filters" role="group" aria-label="Board filters">
          <label for="projectFilter" class="sr-only">Filter by project</label>
          <select id="projectFilter" class="filter-select" aria-label="Filter by project">
            <option value="all">All Projects</option>
            <option value="kitchen">Kitchen</option>
            <option value="basement">Basement</option>
            <option value="bathroom">Bathroom</option>
          </select>

          <label for="priorityFilter" class="sr-only">Filter by priority</label>
          <select id="priorityFilter" class="filter-select" aria-label="Filter by priority">
            <option value="all">All Priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>

        <button id="manageColumnsBtn" class="btn btn-primary" type="button" aria-haspopup="dialog" aria-controls="columnsModal">Columns</button>
      </div>
    </section>

    <!-- Grid -->
    <section class="kanban-grid" aria-label="Kanban columns">
      <article class="kanban-column" data-col="someday">
        <header class="column-header"><div class="column-title">Someday/Maybe <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="someday" aria-label="Someday/Maybe tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>

      <article class="kanban-column" data-col="planning">
        <header class="column-header"><div class="column-title">Research &amp; Planning <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="planning" aria-label="Research & Planning tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>

      <article class="kanban-column" data-col="ready">
        <header class="column-header"><div class="column-title">Permitted &amp; Ready <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="ready" aria-label="Permitted & Ready tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>

      <article class="kanban-column" data-col="in-progress">
        <header class="column-header"><div class="column-title">Active Work <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="in-progress" aria-label="Active Work tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>

      <article class="kanban-column" data-col="blocked">
        <header class="column-header"><div class="column-title">Waiting on External <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="blocked" aria-label="Waiting on External tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>

      <article class="kanban-column" data-col="done">
        <header class="column-header"><div class="column-title">Done Done <span class="task-count">0</span></div></header>
        <div class="task-cards" data-status="done" aria-label="Done Done tasks"></div>
        <div class="add-task-wrap"><button class="add-task-btn" type="button">+ Add task</button></div>
      </article>
    </section>
  </main>

  <!-- App Script (shared) -->
  <script src="atlas-interactive.js"></script>

  <script>
    /* ---------- Header interactions ---------- */
    function toggleMobileMenu(){
      const nav=document.getElementById('mainNav');
      const toggle=document.querySelector('.mobile-menu-toggle');
      const expanded=toggle.getAttribute('aria-expanded')==='true';
      toggle.setAttribute('aria-expanded', String(!expanded));
      nav.style.display=expanded?'':'block';
    }
    function showUserMenu(){ alert('User menu coming soon.'); }

    /* ---------- Simple storage ---------- */
    const KS='atlas_tasks_v2';
    const CS='atlas_hidden_columns_v2';
    const PS='atlas_preferences_v1';
    const getTasks=()=>JSON.parse(localStorage.getItem(KS) || '[]');
    const setTasks=(arr)=>localStorage.setItem(KS, JSON.stringify(arr));
    const getHidden=()=>JSON.parse(localStorage.getItem(CS) || '[]');
    const setHidden=(arr)=>localStorage.setItem(CS, JSON.stringify(arr));
    const getPrefs=()=>JSON.parse(localStorage.getItem(PS) || '{"project":"all","priority":"all"}');
    const setPrefs=(obj)=>localStorage.setItem(PS, JSON.stringify(obj));

    /* ---------- Seed data (only if empty) ---------- */
    function seed(){
      if(getTasks().length) return;
      const today=new Date();
      const addDays=(d)=>{const t=new Date(today);t.setDate(t.getDate()+d);return t.toISOString().slice(0,10);};
      const data=[
        {id:'t1',title:'Install smart dimmers in living room',desc:'Replace 3 gang with Lutron Caseta. Label circuits.',status:'planning',project:'kitchen',priority:'medium',labels:['electrical','smart-home'],due:addDays(7)},
        {id:'t2',title:'Basement framing inspection',desc:'Confirm fire blocking & egress.',status:'ready',project:'basement',priority:'high',labels:['permit'],due:addDays(2)},
        {id:'t3',title:'Order bathroom tile samples',desc:'Green hex, matte black trim.',status:'someday',project:'bathroom',priority:'low',labels:['materials'],due:null},
        {id:'t4',title:'Assemble workbench v2',desc:'French-cleat integration + casters.',status:'in-progress',project:'basement',priority:'medium',labels:['woodworking'],due:addDays(1)},
        {id:'t5',title:'Call electrician for subpanel',desc:'Quote 60A to garage.',status:'blocked',project:'basement',priority:'high',labels:['vendor'],due:addDays(10)},
        {id:'t6',title:'Seal grout in guest bath',desc:'Use solvent-based sealer.',status:'done',project:'bathroom',priority:'low',labels:['maintenance'],due:addDays(-14)}
      ];
      setTasks(data);
    }

    /* ---------- Render ---------- */
    function byStatus(status){return getTasks().filter(t=>t.status===status);}
    function fmtDue(d){
      if(!d) return 'No due';
      const now=new Date().toISOString().slice(0,10);
      const overdue=d<now;
      return `<span class="task-due ${overdue?'overdue':''}">${d}</span>`;
    }
    function makeCard(t){
      const el=document.createElement('article');
      el.className='task-card';
      el.setAttribute('role','article');
      el.setAttribute('tabindex','0');
      el.setAttribute('draggable','true');
      el.dataset.id=t.id;

      el.innerHTML=`
        <div class="task-title">${escapeHtml(t.title)}</div>
        <div class="task-meta">
          <span class="task-project ${escapeHtml(t.project)}">${escapeHtml(cap(t.project))}</span>
          <span class="task-priority">${escapeHtml(cap(t.priority))}</span>
        </div>
        <div class="task-labels">${(t.labels||[]).map(l=>`<span class="task-label">${escapeHtml(l)}</span>`).join('')}</div>
        <div class="task-meta"><span>${fmtDue(t.due)}</span><span>#${escapeHtml(t.id)}</span></div>
      `;

      // Open details
      el.addEventListener('dblclick',()=>openTaskDetail(t.id));
      el.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){e.preventDefault();openTaskDetail(t.id);} });

      // DnD source
      el.addEventListener('dragstart', (e)=>{
        el.setAttribute('aria-grabbed','true');
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData('text/plain', t.id);
        requestAnimationFrame(()=>el.classList.add('dragging'));
      });
      el.addEventListener('dragend', ()=>{
        el.removeAttribute('aria-grabbed');
        el.classList.remove('dragging');
      });

      return el;
    }
    function renderCounts(){
      document.querySelectorAll('.kanban-column').forEach(col=>{
        const key=col.dataset.col;
        const count=byStatus(key).length;
        col.querySelector('.task-count').textContent=String(count);
      });
    }
    function renderBoard(){
      const {project,priority}=getPrefs();
      document.querySelectorAll('.task-cards').forEach(zone=>{
        const status=zone.dataset.status;
        zone.innerHTML='';
        let list=byStatus(status);
        if(project!=='all') list=list.filter(t=>t.project===project);
        if(priority!=='all') list=list.filter(t=>t.priority===priority);
        list.forEach(t=>zone.appendChild(makeCard(t)));
      });
      renderCounts();
    }

    /* ---------- Filters ---------- */
    const projectFilter=document.getElementById('projectFilter');
    const priorityFilter=document.getElementById('priorityFilter');
    function syncFiltersFromPrefs(){
      const p=getPrefs();
      projectFilter.value=p.project||'all';
      priorityFilter.value=p.priority||'all';
    }
    projectFilter.addEventListener('change',()=>{ setPrefs({...getPrefs(),project:projectFilter.value}); renderBoard(); });
    priorityFilter.addEventListener('change',()=>{ setPrefs({...getPrefs(),priority:priorityFilter.value}); renderBoard(); });

    /* ---------- Columns manager ---------- */
    const COLUMNS=[
      {key:'someday',label:'Someday/Maybe'},
      {key:'planning',label:'Research & Planning'},
      {key:'ready',label:'Permitted & Ready'},
      {key:'in-progress',label:'Active Work'},
      {key:'blocked',label:'Waiting on External'},
      {key:'done',label:'Done Done'}
    ];
    document.getElementById('manageColumnsBtn').addEventListener('click',openColumnsModal);
    function openColumnsModal(){
      const hidden=new Set(getHidden());
      const body=`
        <form id="columnsForm" class="task-form">
          <div class="form-row" style="grid-template-columns:1fr;">
            <div class="cols-grid">
              ${COLUMNS.map(c=>`
                <div class="cols-row">
                  <input type="checkbox" id="col-${c.key}" value="${c.key}" ${hidden.has(c.key)?'':'checked'}/>
                  <label for="col-${c.key}">${c.label}</label>
                </div>`).join('')}
            </div>
          </div>
        </form>`;
      const actions=`<button class="btn btn-secondary" data-close>Cancel</button><button class="btn btn-primary" data-apply>Apply</button>`;
      const modal=spawnModal('Manage Columns',body,actions);
      modal.querySelector('[data-close]').addEventListener('click',()=>closeModal(modal));
      modal.querySelector('[data-apply]').addEventListener('click',()=>{
        const kept=[...modal.querySelectorAll('input[type="checkbox"]')].filter(cb=>cb.checked).map(cb=>cb.value);
        const toHide=COLUMNS.map(c=>c.key).filter(k=>!kept.includes(k));
        setHidden(toHide);
        applyHidden();
        closeModal(modal);
      });
    }
    function applyHidden(){
      const hidden=new Set(getHidden());
      document.querySelectorAll('.kanban-column').forEach(col=>{
        const key=col.dataset.col;
        col.style.display=hidden.has(key)?'none':'';
      });
      renderCounts();
    }

    /* ---------- DnD targets ---------- */
    function setupDropzones(){
      document.querySelectorAll('.task-cards').forEach(zone=>{
        // Prevent duplicate listeners: replace node
        const newZone=zone.cloneNode(true);
        zone.parentNode.replaceChild(newZone,zone);

        newZone.addEventListener('dragover',(e)=>{
          e.preventDefault(); e.dataTransfer.dropEffect='move';
          newZone.classList.add('drag-over');
          const dragging=document.querySelector('.task-card.dragging');
          if(!dragging) return;

          const after=getDragAfterElement(newZone,e.clientY);
          if(after==null){ newZone.appendChild(dragging); } else { newZone.insertBefore(dragging,after); }
        });
        newZone.addEventListener('dragleave',(e)=>{ if(e.currentTarget===newZone){ newZone.classList.remove('drag-over'); }});
        newZone.addEventListener('drop',(e)=>{
          e.preventDefault(); newZone.classList.remove('drag-over');
          const id=e.dataTransfer.getData('text/plain');
          if(!id) return;
          const tasks=getTasks();
          const idx=tasks.findIndex(t=>t.id===id);
          if(idx>-1){
            tasks[idx].status=newZone.dataset.status;
            setTasks(tasks);
            renderBoard();
          }
        });
      });
    }
    function getDragAfterElement(container, y){
      const els=[...container.querySelectorAll('.task-card:not(.dragging)')];
      return els.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
      }, {offset:Number.NEGATIVE_INFINITY, element:null}).element;
    }

    /* ---------- Task detail modal ---------- */
    function openTaskDetail(id){
      const t=getTasks().find(x=>x.id===id);
      if(!t) return;
      const body=`
        <form id="taskForm" class="task-form">
          <div class="form-row">
            <div>
              <label>Title</label>
              <input type="text" name="title" value="${escapeAttr(t.title)}" required/>
            </div>
            <div>
              <label>Project</label>
              <select name="project">
                <option value="kitchen" ${t.project==='kitchen'?'selected':''}>Kitchen</option>
                <option value="basement" ${t.project==='basement'?'selected':''}>Basement</option>
                <option value="bathroom" ${t.project==='bathroom'?'selected':''}>Bathroom</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Status</label>
              <select name="status">
                ${COLUMNS.map(c=>`<option value="${c.key}" ${t.status===c.key?'selected':''}>${c.label}</option>`).join('')}
              </select>
            </div>
            <div>
              <label>Priority</label>
              <select name="priority">
                <option value="high" ${t.priority==='high'?'selected':''}>High</option>
                <option value="medium" ${t.priority==='medium'?'selected':''}>Medium</option>
                <option value="low" ${t.priority==='low'?'selected':''}>Low</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="grid-template-columns:1fr;">
            <div>
              <label>Description</label>
              <textarea name="desc">${escapeHtml(t.desc||'')}</textarea>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Due Date</label>
              <input type="text" name="due" value="${escapeAttr(t.due||'')}" placeholder="YYYY-MM-DD or blank"/>
            </div>
            <div>
              <label>Labels (comma-separated)</label>
              <input type="text" name="labels" value="${escapeAttr((t.labels||[]).join(', '))}"/>
            </div>
          </div>
        </form>
      `;
      const actions=`
        <button class="btn btn-danger" data-delete>Delete</button>
        <span style="flex:1"></span>
        <button class="btn btn-secondary" data-close>Cancel</button>
        <button class="btn btn-primary" data-save>Save</button>
      `;
      const modal=spawnModal('Task Details', body, actions);
      modal.querySelector('[data-close]').addEventListener('click',()=>closeModal(modal));
      modal.querySelector('[data-delete]').addEventListener('click',()=>{
        const tasks=getTasks().filter(x=>x.id!==id);
        setTasks(tasks); closeModal(modal); renderBoard();
      });
      modal.querySelector('[data-save]').addEventListener('click',()=>{
        const f=modal.querySelector('#taskForm');
        const tasks=getTasks();
        const i=tasks.findIndex(x=>x.id===id);
        if(i>-1){
          tasks[i]={...tasks[i],
            title:f.title.value.trim(),
            project:f.project.value,
            status:f.status.value,
            priority:f.priority.value,
            desc:f.desc.value.trim(),
            due:f.due.value.trim()||null,
            labels:f.labels.value.split(',').map(s=>s.trim()).filter(Boolean)
          };
          setTasks(tasks);
        }
        closeModal(modal); renderBoard();
      });
    }

    /* ---------- Quick Add ---------- */
    document.getElementById('quickAddBtn').addEventListener('click',()=>openAddTaskModal('planning'));
    document.querySelectorAll('.add-task-btn').forEach((btn)=>{
      btn.addEventListener('click',()=>{
        const col=btn.closest('.kanban-column')?.dataset.col || 'planning';
        openAddTaskModal(col);
      });
    });
    function openAddTaskModal(defaultStatus='planning'){
      const body=`
        <form id="newTaskForm" class="task-form">
          <div class="form-row">
            <div><label>Title</label><input type="text" name="title" required placeholder="What needs doing?"/></div>
            <div>
              <label>Status</label>
              <select name="status">${COLUMNS.map(c=>`<option value="${c.key}" ${c.key===defaultStatus?'selected':''}>${c.label}</option>`).join('')}</select>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Project</label>
              <select name="project">
                <option value="kitchen">Kitchen</option>
                <option value="basement">Basement</option>
                <option value="bathroom">Bathroom</option>
              </select>
            </div>
            <div>
              <label>Priority</label>
              <select name="priority">
                <option value="high">High</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="grid-template-columns:1fr;">
            <div><label>Description</label><textarea name="desc" placeholder="Add notes, links, measurementsâ€¦"></textarea></div>
          </div>
          <div class="form-row">
            <div><label>Due Date</label><input type="text" name="due" placeholder="YYYY-MM-DD"/></div>
            <div><label>Labels (comma-separated)</label><input type="text" name="labels" placeholder="materials, wiring"/></div>
          </div>
        </form>
      `;
      const actions=`<button class="btn btn-secondary" data-close>Cancel</button><button class="btn btn-primary" data-create>Create</button>`;
      const modal=spawnModal('Add Task',body,actions);
      modal.querySelector('[data-close]').addEventListener('click',()=>closeModal(modal));
      modal.querySelector('[data-create]').addEventListener('click',()=>{
        const f=modal.querySelector('#newTaskForm');
        if(!f.reportValidity()) return;
        const tasks=getTasks();
        const id='t'+(Math.max(0,...tasks.map(t=>+(t.id||'t0').replace('t','')))+1);
        tasks.push({
          id, title:f.title.value.trim(), status:f.status.value, project:f.project.value, priority:f.priority.value,
          desc:f.desc.value.trim(), due:f.due.value.trim()||null,
          labels:f.labels.value.split(',').map(s=>s.trim()).filter(Boolean)
        });
        setTasks(tasks); closeModal(modal); renderBoard();
      });
    }

    /* ---------- Utility ---------- */
    function cap(s){return (s||'').slice(0,1).toUpperCase()+s.slice(1);}
    function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
    function escapeAttr(s){return escapeHtml(s).replace(/"/g,'&quot;');}

    function spawnModal(title, bodyHTML, actionsHTML){
      const wrap=document.createElement('div'); wrap.className='modal-overlay';
      wrap.innerHTML=`
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <div class="modal-header">
            <h3 id="modalTitle">${escapeHtml(title)}</h3>
            <button class="btn-icon" data-x aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">${bodyHTML}</div>
          <div class="modal-actions">${actionsHTML||''}</div>
        </div>`;
      document.body.appendChild(wrap);
      wrap.querySelector('[data-x]')?.addEventListener('click',()=>closeModal(wrap));
      return wrap;
    }
    function closeModal(node){ node?.remove(); }

    /* ---------- Init ---------- */
    (function init(){
      seed();
      syncFiltersFromPrefs();
      renderBoard();
      applyHidden();
      setupDropzones();
    })();

    // Rebind dropzones each render
    const _renderBoard=renderBoard;
    renderBoard=function(){ _renderBoard(); setupDropzones(); };

    // Keep counts and layout correct when storage changes (multi-tab)
    window.addEventListener('storage',(e)=>{
      if(e.key===KS || e.key===CS || e.key===PS){ renderBoard(); applyHidden(); }
    });
  </script>
</body>
</html>
