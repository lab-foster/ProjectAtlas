<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Project Atlas ‚Äì Kanban board with dependencies, drag & drop, editable task modal, and configurable columns."/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Kanban Board - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üóÇÔ∏è</text></svg>"/>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* Make the board use full page height naturally (no inner scrolling panes) */
    html, body { height: 100%; }
    body.app-page { min-height: 100%; }

    /* Kanban layout tweaks so the page scrolls (not an inner div) */
    .kanban {
      --col-gap: 16px;
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(260px, 1fr);
      gap: var(--col-gap);
      align-items: start;
      /* allow horizontal scroll if too many columns, but keep it at page level */
      overflow: visible;
    }

    /* Columns grow with content; no hard max-height */
    .kanban-column { max-height: none; }

    /* Keep filters tight to reduce wasted vertical space */
    .filters { margin-top: .5rem; }

    /* Optional: horizontal scroll helper on small screens */
    .kanban-wrapper {
      width: 100%;
      overflow-x: auto;   /* only horizontal overflow (page still controls vertical) */
      overflow-y: visible;
      padding-bottom: .5rem;
    }
  </style>
</head>
<body class="app-page">
  <a href="#main" class="skip-to-main">Skip to main content</a>

  <!-- Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="mainNav"
              onclick="toggleMobileMenu()"><span aria-hidden="true">‚ò∞</span></button>

      <nav id="mainNav" class="main-nav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html" class="active" aria-current="page">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu">
        <button class="btn btn-secondary" onclick="openCreateTask()" aria-label="Add task">+ Task</button>
        <button class="btn btn-secondary" onclick="openColumnsDialog()" aria-label="Configure columns">Columns</button>
        <button class="user-avatar" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main" class="dashboard-container" style="padding-top:1rem;">
    <section class="dashboard-header" style="margin-bottom:.75rem;">
      <h2 id="boardTitle">Kanban Board</h2>
      <p class="text-tertiary">Drag cards between columns. Click a card to view & edit details.</p>

      <div class="form-row filters">
        <div>
          <label for="searchTasks">Search</label>
          <input id="searchTasks" class="input" placeholder="Search by title, description, or tags‚Ä¶" oninput="applyFilters()"/>
        </div>
        <div>
          <label for="assigneeFilter">Assignee</label>
          <select id="assigneeFilter" class="input" onchange="applyFilters()">
            <option value="">All</option>
            <option value="Andrew">Andrew</option>
            <option value="Katie">Katie</option>
            <option value="Contractor">Contractor</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Board (full-page height; page scrolls, not an inner panel) -->
    <div class="kanban-wrapper">
      <section id="kanban" class="kanban" aria-label="Kanban board">
        <!-- Columns injected by JS -->
      </section>
    </div>
  </main>

  <!-- Reusable Backdrop & Modal Root (used for Task Details + Create + Columns) -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <!-- Scripts -->
  <script>
    // ---------- Mobile Nav ----------
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const btn = document.querySelector('.mobile-menu-toggle');
      const on = nav.classList.toggle('active');
      btn.setAttribute('aria-expanded', on);
    }
    document.addEventListener('click',(e)=>{
      const nav = document.getElementById('mainNav');
      const btn = document.querySelector('.mobile-menu-toggle');
      if(nav.classList.contains('active') && !nav.contains(e.target) && !btn.contains(e.target)){
        toggleMobileMenu();
      }
    });

    // ---------- Storage & Model ----------
    const defaultStatuses = ["Someday","Planning","Ready","In Progress","Blocked","Done"];

    const storage = {
      keyTasks: "atlas.kanban.tasks",
      keyStatuses: "atlas.kanban.statuses",
      getTasks(){ try{ return JSON.parse(localStorage.getItem(this.keyTasks)) || seedTasks; }catch{ return seedTasks; } },
      saveTasks(v){ localStorage.setItem(this.keyTasks, JSON.stringify(v)); },
      getStatuses(){ try{ return JSON.parse(localStorage.getItem(this.keyStatuses)) || defaultStatuses; }catch{ return defaultStatuses; } },
      saveStatuses(v){ localStorage.setItem(this.keyStatuses, JSON.stringify(v)); }
    };

    // Seed (first load only)
    const seedTasks = [
      {id:"t1", title:"Research countertop materials", desc:"Quartz vs granite. Look at Costco & local fabricators.", status:"Someday", project:"kitchen", assignee:"Andrew", priority:"Low",  due:"",          deps:[]},
      {id:"t2", title:"Submit basement permit",       desc:"City of Woodinville online portal",                     status:"Planning", project:"basement", assignee:"Andrew", priority:"High", due:"2025-10-18", deps:[]},
      {id:"t3", title:"Order bathroom vanity",        desc:"36‚Äù oak, matte black hardware ‚Äì Home Depot",           status:"Ready",    project:"bathroom", assignee:"Katie",  priority:"Medium",due:"2025-10-15", deps:[]},
      {id:"t4", title:"Install backsplash",           desc:"Subway tile herringbone. Use leveling clips.",         status:"In Progress", project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-20", deps:["t6"]},
      {id:"t5", title:"Seal grout",                   desc:"After 72 hours, apply two coats.",                     status:"Blocked",  project:"kitchen", assignee:"Andrew", priority:"Low",  due:"",          deps:["t4"]},
      {id:"t6", title:"Countertop template",          desc:"Schedule template after cabinet alignment.",           status:"Done",     project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-10", deps:[]},
    ];

    let tasks = storage.getTasks();
    let STATUSES = storage.getStatuses();
    let filterText = "";
    let filterAssignee = "";

    // URL project param
    const params = new URLSearchParams(location.search);
    const projectParam = params.get("project");
    if(projectParam){
      const pretty = projectParam.charAt(0).toUpperCase()+projectParam.slice(1);
      document.getElementById("boardTitle").textContent = `${pretty} ‚Äì Kanban Board`;
    }

    // ---------- Rendering ----------
    const $board = document.getElementById("kanban");

    function renderBoard(){
      $board.innerHTML = "";
      const filtered = tasks.filter(t => {
        const matchesText = !filterText || (t.title + " " + t.desc).toLowerCase().includes(filterText);
        const matchesAssignee = !filterAssignee || t.assignee === filterAssignee;
        const matchesProject = !projectParam || t.project === projectParam;
        return matchesText && matchesAssignee && matchesProject;
      });

      STATUSES.forEach(status => {
        const col = document.createElement("section");
        col.className = "kanban-column";
        col.dataset.status = status;
        col.innerHTML = `
          <header class="flex items-center justify-between">
            <span class="col-title">${status}</span>
            <div class="flex items-center gap-sm">
              <span class="text-tertiary" id="count-${slug(status)}">0</span>
              <button class="btn btn-secondary" onclick="openCreateTask('${status}')" aria-label="Add task to ${status}">+ Task</button>
            </div>
          </header>
          <div class="kanban-list" role="list"></div>
        `;
        const list = col.querySelector(".kanban-list");

        // Allow drops
        list.addEventListener("dragover", e => { e.preventDefault(); list.classList.add("kanban-drop-target"); });
        list.addEventListener("dragleave", () => list.classList.remove("kanban-drop-target"));
        list.addEventListener("drop", e => {
          e.preventDefault();
          list.classList.remove("kanban-drop-target");
          const id = e.dataTransfer.getData("text/plain");
          moveTaskToStatus(id, status);
        });

        // Cards
        const cards = filtered.filter(t => t.status === status);
        cards.forEach(t => list.appendChild(renderCard(t)));
        col.querySelector(`#count-${slug(status)}`).textContent = cards.length;

        $board.appendChild(col);
      });
    }

    function renderCard(t){
      const card = document.createElement("article");
      card.className = "kanban-card";
      card.setAttribute("draggable","true");
      card.id = t.id;
      const depBadge = t.deps && t.deps.length ? `<span title="Has dependencies" aria-label="dependencies">‚õìÔ∏è</span>` : "";
      const priorityDot = t.priority==="High" ? "üî¥" : t.priority==="Medium" ? "üü†" : "üü¢";
      card.innerHTML = `
        <div class="flex justify-between items-center">
          <strong>${escapeHtml(t.title)}</strong>
          <span title="Priority">${priorityDot}</span>
        </div>
        <div class="text-tertiary" style="margin-top:.25rem; font-size:.9rem;">${escapeHtml(t.desc)}</div>
        <div class="flex items-center gap-sm" style="margin-top:.4rem; font-size:.85rem;">
          <span title="Assignee">üë§ ${escapeHtml(t.assignee)}</span>
          ${t.due ? `<span title="Due date">üóìÔ∏è ${t.due}</span>` : ""}
          ${depBadge}
        </div>
      `;

      // Drag handlers
      card.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", t.id);
        requestAnimationFrame(()=>card.classList.add("dragging"));
      });
      card.addEventListener("dragend", ()=> card.classList.remove("dragging"));

      // Click to open details modal (edit)
      card.addEventListener("click", ()=> openTaskModal(t.id));
      return card;
    }

    function slug(s){ return s.replace(/\s/g,''); }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m])); }

    // ---------- Filters ----------
    function applyFilters(){
      filterText = document.getElementById("searchTasks").value.trim().toLowerCase();
      filterAssignee = document.getElementById("assigneeFilter").value;
      renderBoard();
    }

    // ---------- Move ----------
    function moveTaskToStatus(id, status){
      const idx = tasks.findIndex(x=>x.id===id);
      if(idx===-1) return;
      // Guard: cannot start if deps not done
      if(status==="In Progress" && tasks[idx].deps && tasks[idx].deps.length){
        const unmet = tasks[idx].deps.filter(d => (tasks.find(x=>x.id===d)||{}).status !== "Done");
        if(unmet.length){ showToast("Cannot start ‚Äì dependencies not Done."); return; }
      }
      tasks[idx].status = status;
      storage.saveTasks(tasks);
      renderBoard();
    }

    // ---------- Modal Helpers ----------
    function openModal(title, bodyHtml, footerHtml){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop = document.getElementById("backdrop");
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${title}">
          <div class="modal-header">
            <h3 class="modal-title">${title}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">${bodyHtml}</div>
          <div class="modal-footer">${footerHtml || `<button class="btn" onclick="closeModal()">Close</button>`}</div>
        </div>
      `;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }
    function closeModal(){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop = document.getElementById("backdrop");
      modalRoot.innerHTML = "";
      modalRoot.classList.remove("open");
      backdrop.classList.remove("show");
      document.body.classList.remove("atlas-modal-open");
    }

    // ---------- Task: Create ----------
    function openCreateTask(defaultStatus){
      const options = STATUSES.map(s=>`<option ${defaultStatus===s?"selected":""}>${s}</option>`).join("");
      openModal("Create Task", `
        <div class="form-grid">
          <label for="new_title">Title *</label>
          <input id="new_title" class="input" placeholder="e.g. Schedule plumbing inspection"/>

          <label for="new_desc">Description</label>
          <textarea id="new_desc" class="input" placeholder="Add helpful context"></textarea>

          <div class="form-row">
            <div>
              <label for="new_status">Status</label>
              <select id="new_status" class="input">${options}</select>
            </div>
            <div>
              <label for="new_assignee">Assignee</label>
              <select id="new_assignee" class="input">
                <option>Andrew</option><option>Katie</option><option>Contractor</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="new_priority">Priority</label>
              <select id="new_priority" class="input">
                <option>Low</option><option selected>Medium</option><option>High</option>
              </select>
            </div>
            <div>
              <label for="new_due">Due Date</label>
              <input id="new_due" type="date" class="input"/>
            </div>
          </div>

          <label for="new_deps">Dependencies (comma IDs)</label>
          <input id="new_deps" class="input" placeholder="e.g. t4,t6"/>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="createTask()">Create Task</button>
      `);
    }
    function createTask(){
      const title = document.getElementById("new_title").value.trim();
      if(!title){ showToast("Title is required."); return; }
      const desc = document.getElementById("new_desc").value.trim();
      const status = document.getElementById("new_status").value;
      const assignee = document.getElementById("new_assignee").value;
      const priority = document.getElementById("new_priority").value;
      const due = document.getElementById("new_due").value;
      const deps = document.getElementById("new_deps").value.trim();
      const id = "t" + Math.random().toString(36).slice(2,7);
      tasks.push({ id, title, desc, status, assignee, priority, due,
        deps: deps ? deps.split(",").map(s=>s.trim()).filter(Boolean) : [],
        project: projectParam || "general"
      });
      storage.saveTasks(tasks);
      closeModal();
      renderBoard();
      showToast("Task created.");
    }

    // ---------- Task: View/Edit (POPUP MODAL) ----------
    function openTaskModal(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;

      // Prefer full app modal if present
      if(window.atlas && typeof window.atlas.showTaskDetailModal === "function"){
        window.atlas.showTaskDetailModal(t);
        return;
      }

      const statusOptions = STATUSES.map(s=>`<option ${t.status===s?"selected":""}>${s}</option>`).join("");
      const depsHtml = (t.deps||[]).map(d=>{
        const dTask = tasks.find(x=>x.id===d);
        const done = dTask && dTask.status==="Done";
        return `<li>${done?"‚úÖ":"‚è≥"} ${escapeHtml(dTask?dTask.title:d)}</li>`;
      }).join('');

      const body = `
        <div class="form-grid">
          <label for="task_title_${id}">Title *</label>
          <input id="task_title_${id}" class="input" value="${escapeHtml(t.title)}"/>

          <label for="task_desc_${id}">Description</label>
          <textarea id="task_desc_${id}" class="input">${escapeHtml(t.desc)}</textarea>

          <div class="form-row">
            <div>
              <label for="task_status_${id}">Status</label>
              <select id="task_status_${id}" class="input">${statusOptions}</select>
            </div>
            <div>
              <label for="task_assignee_${id}">Assignee</label>
              <select id="task_assignee_${id}" class="input">
                ${["Andrew","Katie","Contractor"].map(a=>`<option ${t.assignee===a?"selected":""}>${a}</option>`).join("")}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="task_priority_${id}">Priority</label>
              <select id="task_priority_${id}" class="input">
                ${["Low","Medium","High"].map(p=>`<option ${t.priority===p?"selected":""}>${p}</option>`).join("")}
              </select>
            </div>
            <div>
              <label for="task_due_${id}">Due Date</label>
              <input id="task_due_${id}" type="date" class="input" value="${t.due || ""}"/>
            </div>
          </div>

          <label for="task_deps_${id}">Dependencies (comma IDs)</label>
          <input id="task_deps_${id}" class="input" value="${(t.deps||[]).join(',')}"/>

          ${t.deps && t.deps.length ? `<div class="divider"></div><div><strong>Dependency Status</strong><ul>${depsHtml}</ul></div>` : ""}

          <div class="divider"></div>
          <div class="text-tertiary">ID: ${t.id} ‚Ä¢ Project: ${t.project}</div>
        </div>
      `;
      const footer = `
        <button class="btn btn-secondary" onclick="deleteTask('${id}')">Delete</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn" onclick="saveTask('${id}')">Save Changes</button>
      `;
      openModal("Task Details", body, footer);
    }

    function saveTask(id){
      const i = tasks.findIndex(x=>x.id===id);
      if(i<0) return;
      const g = (sel)=>document.getElementById(sel).value;
      tasks[i].title    = g(`task_title_${id}`).trim() || tasks[i].title;
      tasks[i].desc     = g(`task_desc_${id}`).trim();
      tasks[i].status   = g(`task_status_${id}`);
      tasks[i].assignee = g(`task_assignee_${id}`);
      tasks[i].priority = g(`task_priority_${id}`);
      tasks[i].due      = g(`task_due_${id}`);
      const deps        = g(`task_deps_${id}`).trim();
      tasks[i].deps     = deps ? deps.split(",").map(s=>s.trim()).filter(Boolean) : [];
      storage.saveTasks(tasks);
      closeModal();
      renderBoard();
      showToast("Task updated.");
    }

    function deleteTask(id){
      if(!confirm("Delete this task?")) return;
      tasks = tasks.filter(t=>t.id!==id);
      storage.saveTasks(tasks);
      closeModal();
      renderBoard();
      showToast("Task deleted.");
    }

    // ---------- Columns: Add / Edit / Delete / Reorder ----------
    function openColumnsDialog(){
      const body = `
        <div class="form-grid" id="columnsEditor">
          ${STATUSES.map((s, idx)=>columnRowTemplate(s, idx)).join("")}
          <button class="btn btn-secondary" onclick="addColumnRow()">+ Add Column</button>
          <div class="divider"></div>
          <div class="text-tertiary">Rename, reorder, or delete columns. Changes are saved to this device.</div>
        </div>
      `;
      const footer = `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="saveColumns()">Save Columns</button>
      `;
      openModal("Configure Columns", body, footer);
    }

    function columnRowTemplate(name, idx){
      return `
        <div class="flex items-center gap-sm" data-row="${idx}">
          <input class="input" value="${escapeHtml(name)}" placeholder="Column name" style="flex:1"/>
          <button class="btn btn-secondary" onclick="moveColumnRow(this,-1)" title="Move up">‚Üë</button>
          <button class="btn btn-secondary" onclick="moveColumnRow(this,1)" title="Move down">‚Üì</button>
          <button class="btn btn-secondary" onclick="deleteColumnRow(this)" title="Delete">‚úï</button>
        </div>
      `;
    }

    function addColumnRow(){
      const editor = document.getElementById("columnsEditor");
      const div = document.createElement("div");
      div.innerHTML = columnRowTemplate("", Date.now());
      editor.insertBefore(div.firstElementChild, editor.querySelector("button.btn.btn-secondary"));
    }
    function deleteColumnRow(btn){
      const row = btn.closest('[data-row]');
      row.parentNode.removeChild(row);
    }
    function moveColumnRow(btn, dir){
      const row = btn.closest('[data-row]');
      const parent = row.parentNode;
      if(dir<0 && row.previousElementSibling){ parent.insertBefore(row, row.previousElementSibling); }
      if(dir>0 && row.nextElementSibling && !row.nextElementSibling.matches('button')) {
        parent.insertBefore(row.nextElementSibling, row);
      }
    }
    function saveColumns(){
      const rows = Array.from(document.querySelectorAll('#columnsEditor [data-row]'));
      const names = rows.map(r => r.querySelector('input').value.trim()).filter(Boolean);
      if(!names.length){ showToast("At least one column is required."); return; }
      STATUSES = names;
      storage.saveStatuses(STATUSES);

      // Normalize any task statuses that no longer exist -> first column
      tasks = tasks.map(t => ({...t, status: STATUSES.includes(t.status) ? t.status : STATUSES[0]}));
      storage.saveTasks(tasks);

      closeModal();
      renderBoard();
      showToast("Columns updated.");
    }

    // ---------- Toast ----------
    let toastTimer;
    function showToast(msg, type="info"){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.className = "toast info";
        document.body.appendChild(el);
      }
      el.className = `toast ${type}`;
      el.textContent = msg;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.remove(), 2200);
    }

    // ---------- Init ----------
    renderBoard();

    // Expose for console debugging if needed
    window.AtlasKanban = { tasks, STATUSES, renderBoard };
  </script>

  <!-- App script (if present, enhances with backend, etc.) -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
